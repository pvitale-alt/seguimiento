<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Seguimiento de Proyectos | Seguimiento</title>
    
    <!-- CSS -->
    <link rel="stylesheet" href="/css/main.css?v=<%= Date.now() %>">
    
    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="/images/logo.ico">
</head>
<body>
    <!-- Header General -->
    <header class="top-header">
        <div style="display: flex; align-items: center; gap: 12px;">
            <a href="/" style="display: flex; align-items: center; text-decoration: none;">
                <img src="/images/Mercap-logo-horizontal-1920x1080.png" alt="Logo Mercap" style="height: 70px; width: auto; display: block;" onerror="this.style.display='none';" />
            </a>
        </div>
    </header>
    
    <div class="app-container">
        <%- include('../partials/sidebar', { productosEquipos, productoActual, equipoActual, tipoActual, isAdmin }) %>
        
        <div class="main-content">
            <div class="content-area" style="position: relative;">
                <!-- Imagen de fondo con opacidad -->
                <div style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; z-index: 0; opacity: 0.2; background-image: url('/images/cover.png'); background-size: cover; background-position: center; background-repeat: no-repeat; pointer-events: none;"></div>
                <div style="position: relative; z-index: 1;">
                <% if (productoActual) { %>
                <!-- Contenedor agrupado: T√≠tulo, Tabs y Filtros -->
                <div style="background: white; border-radius: 12px; box-shadow: 0 1px 2px 0 rgba(60,64,67,.3), 0 1px 3px 1px rgba(60,64,67,.15); position: relative; z-index: 2; margin-bottom: 16px; overflow: hidden;">
                    <!-- T√≠tulo (solo cuando hay producto seleccionado) -->
                    <div style="padding: 16px 24px; position: relative; z-index: 2;">
                        <h1 style="font-size: 32px; font-weight: 500; color: #5f6368; margin: 0; font-family: 'Google Sans', 'Roboto', sans-serif;">
                            Seguimiento<% if (equipoNombre) { %> - <%= equipoNombre %><% } %>
                        </h1>
                    </div>
                    <div class="tabs" style="padding: 0 24px; margin: 0; display: flex; justify-content: space-between; align-items: center; position: relative; z-index: 2; border-top: 1px solid var(--border-color);">
                        <div style="display: flex;">
                            <a 
                                href="/?producto=<%= encodeURIComponent(productoActual || '') %>&equipo=<%= encodeURIComponent(equipoActual || '') %>&tipo=mantenimiento" 
                                class="tab <%= tipoActual === 'mantenimiento' ? 'active' : '' %>"
                            >
                                Mantenimiento
                            </a>
                            <a 
                                href="/?producto=<%= encodeURIComponent(productoActual || '') %>&equipo=<%= encodeURIComponent(equipoActual || '') %>&tipo=proyectos" 
                                class="tab <%= tipoActual === 'proyectos' ? 'active' : '' %>"
                            >
                                Proyectos
                            </a>
                        </div>
                    </div>
                    <!-- Filtros y buscador solo para proyectos -->
                    <% if (tipoActual === 'proyectos') { %>
                    <div id="filtrosProyectos" style="padding: 16px 24px; margin-top: 0; display: flex; align-items: center; gap: 12px; flex-wrap: wrap; position: relative; z-index: 2; border-top: 1px solid var(--border-color);">
                    <div style="display: flex; align-items: center; gap: 12px; flex-wrap: wrap;">
                    <!-- Filtro Cliente -->
                    <button class="filter-btn" onclick="toggleFilterClientes(this)" title="Filtrar por Cliente">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" style="width: 18px; height: 18px;">
                            <path d="M10 18h4v-2h-4v2zM3 6v2h18V6H3zm3 7h12v-2H6v2z"/>
                        </svg>
                        <span style="margin-left: 6px; font-size: 13px;">Cliente</span>
                    </button>
                    <div class="filter-dropdown" id="filterClientes" style="display: none;"></div>
                    
                    <!-- Filtro Estado -->
                    <button class="filter-btn" onclick="toggleFilterEstados(this)" title="Filtrar por Estado">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" style="width: 18px; height: 18px;">
                            <path d="M10 18h4v-2h-4v2zM3 6v2h18V6H3zm3 7h12v-2H6v2z"/>
                        </svg>
                        <span style="margin-left: 6px; font-size: 13px;">Estado</span>
                    </button>
                    <div class="filter-dropdown" id="filterEstados" style="display: none;">
                        <div style="padding: 8px 16px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center;">
                            <button onclick="seleccionarTodosEstados()" style="background: none; border: none; color: var(--primary-color); font-size: 13px; font-weight: 500; cursor: pointer; padding: 4px 8px;">Todos</button>
                            <button onclick="deseleccionarTodosEstados()" style="background: none; border: none; color: var(--text-secondary); font-size: 13px; cursor: pointer; padding: 4px 8px;">Borrar todos</button>
                        </div>
                        <label style="display: flex; align-items: center; padding: 10px 16px; cursor: pointer; transition: background 0.2s;" onmouseover="this.style.background='#f1f3f4'" onmouseout="this.style.background='white'">
                            <input type="checkbox" class="filter-checkbox-estado" value="sin comenzar" style="margin-right: 8px; cursor: pointer;" onchange="aplicarFiltrosProyectos()" />
                            <span style="font-size: 13px;">Sin comenzar</span>
                        </label>
                        <label style="display: flex; align-items: center; padding: 10px 16px; cursor: pointer; transition: background 0.2s;" onmouseover="this.style.background='#f1f3f4'" onmouseout="this.style.background='white'">
                            <input type="checkbox" class="filter-checkbox-estado" value="en curso" style="margin-right: 8px; cursor: pointer;" onchange="aplicarFiltrosProyectos()" />
                            <span style="font-size: 13px;">En curso</span>
                        </label>
                        <label style="display: flex; align-items: center; padding: 10px 16px; cursor: pointer; transition: background 0.2s;" onmouseover="this.style.background='#f1f3f4'" onmouseout="this.style.background='white'">
                            <input type="checkbox" class="filter-checkbox-estado" value="Testing" style="margin-right: 8px; cursor: pointer;" onchange="aplicarFiltrosProyectos()" />
                            <span style="font-size: 13px;">Testing</span>
                        </label>
                        <label style="display: flex; align-items: center; padding: 10px 16px; cursor: pointer; transition: background 0.2s;" onmouseover="this.style.background='#f1f3f4'" onmouseout="this.style.background='white'">
                            <input type="checkbox" class="filter-checkbox-estado" value="Entregado" style="margin-right: 8px; cursor: pointer;" onchange="aplicarFiltrosProyectos()" />
                            <span style="font-size: 13px;">Entregado</span>
                        </label>
                        <label style="display: flex; align-items: center; padding: 10px 16px; cursor: pointer; transition: background 0.2s;" onmouseover="this.style.background='#f1f3f4'" onmouseout="this.style.background='white'">
                            <input type="checkbox" class="filter-checkbox-estado" value="Rework" style="margin-right: 8px; cursor: pointer;" onchange="aplicarFiltrosProyectos()" />
                            <span style="font-size: 13px;">Rework</span>
                        </label>
                        <label style="display: flex; align-items: center; padding: 10px 16px; cursor: pointer; transition: background 0.2s;" onmouseover="this.style.background='#f1f3f4'" onmouseout="this.style.background='white'">
                            <input type="checkbox" class="filter-checkbox-estado" value="Bloqueado" style="margin-right: 8px; cursor: pointer;" onchange="aplicarFiltrosProyectos()" />
                            <span style="font-size: 13px;">Bloqueado</span>
                        </label>
                    </div>
                    </div>
                    
                    <!-- Buscador (centrado) -->
                    <div style="position: relative; flex: 1; max-width: 900px; min-width: 500px; margin: 0 auto; display: flex; justify-content: center;">
                        <form onsubmit="buscar(event)" class="google-search-box" style="position: relative; width: 100%;">
                            <div class="google-search-box-container" id="searchBoxContainer" style="display: flex; align-items: center;">
                                <svg style="width: 20px; height: 20px; color: #9aa0a6; margin-right: 12px; flex-shrink: 0;" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/>
                                </svg>
                                <textarea 
                                    id="searchInput" 
                                    class="google-search-input"
                                    rows="1"
                                    placeholder="Buscar proyectos..."
                                    autocomplete="off"
                                    autocapitalize="off"
                                    autocorrect="off"
                                    spellcheck="false"
                                    style="flex: 1; border: none; outline: none; font-size: 16px; font-family: 'Google Sans', 'Roboto', sans-serif; resize: none; overflow: hidden; padding: 0; margin: 0; background: transparent; line-height: 44px; max-height: 44px;"
                                    oninput="this.style.height='auto'; this.style.height=Math.min(this.scrollHeight, 44)+'px'; buscarSugerencias(this.value); actualizarBotonLimpiar(this.value);"
                                    onkeydown="if(event.key === 'Enter') { event.preventDefault(); buscar(event); }"
                                ></textarea>
                                <button 
                                    id="btnLimpiarBusqueda" 
                                    onclick="limpiarBusqueda()" 
                                    style="display: none; background: none; border: none; cursor: pointer; padding: 8px; margin-left: 8px; color: #5f6368; transition: color 0.2s; align-items: center; justify-content: center;"
                                    onmouseover="this.style.color='#202124'"
                                    onmouseout="this.style.color='#5f6368'"
                                    title="Limpiar b√∫squeda"
                                >
                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                                        <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
                                    </svg>
                                </button>
                            </div>
                            <!-- Sugerencias -->
                            <div id="searchSuggestions" class="google-search-suggestions"></div>
                        </form>
                    </div>
                    
                    <!-- Bot√≥n Sincronizar y Checkbox "Incluir cerrados" -->
                    <div style="display: flex; align-items: center; gap: 12px; margin-left: auto;">
                        <button class="button button-secondary" onclick="sincronizar()" id="btnSincronizar">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/>
                            </svg>
                            <span>Sincronizar</span>
                        </button>
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; user-select: none;">
                            <input type="checkbox" id="incluirCerrados" style="cursor: pointer;" onchange="aplicarFiltrosProyectos()" />
                            <span style="font-size: 13px; color: var(--text-secondary);">Incluir cerrados</span>
                            <span id="contadorProyectos" style="font-size: 13px; color: var(--text-secondary); font-weight: 500; margin-left: 4px;">total proyectos: 0</span>
                        </label>
                    </div>
                    <% } %>
                </div>
                <!-- Chips de filtros aplicados (debajo del panel de filtros) -->
                <div id="filtrosAplicados" style="display: none; padding: 12px 24px; background: white; border-bottom: 1px solid var(--border-color); flex-wrap: wrap; gap: 8px; align-items: center; position: relative; z-index: 2;"></div>
                <% } %>

                <div id="contenido" class="table-container">
                    <div class="empty-state">
                        <div class="spinner"></div>
                        <div class="empty-state-text">Cargando datos...</div>
                    </div>
                </div>
                </div>
            </div>
        </div>
    </div>

<script>
    const productoActual = '<%= productoActual || '' %>';
    const equipoActual = '<%= equipoActual || '' %>';
    const tipoActual = '<%= tipoActual || 'mantenimiento' %>';
    let busquedaActual = '';
    let filtrosClientes = [];
    let filtrosEstados = [];
    let datosTablaActual = []; // Almacenar datos actuales de la tabla para el filtro de clientes
    let datosOriginales = []; // Almacenar datos originales (sin filtros de clientes/estados) para el filtro de clientes

    // Funciones helper para crear dropdowns personalizados
    function crearDropdownOverall(idProyecto, campo, valorActual, clasesAdicionales) {
        // Verificar si clasesAdicionales contiene 'subproyecto' (puede tener m√∫ltiples clases separadas por espacio)
        const esSubproyecto = clasesAdicionales && clasesAdicionales.includes('subproyecto');
        // Usar prefijo diferente para subproyectos para evitar colisiones de IDs
        const dropdownId = esSubproyecto ? 'dropdown-' + campo + '-sub-' + idProyecto : 'dropdown-' + campo + '-' + idProyecto;
        const valorActualClass = valorActual ? 'color-' + valorActual : '';
        const opciones = [
            { valor: '', texto: '-', icono: '-' },
            { valor: 'verde', texto: 'üü¢', icono: 'üü¢' },
            { valor: 'amarillo', texto: 'üü°', icono: 'üü°' },
            { valor: 'rojo', texto: 'üî¥', icono: 'üî¥' }
        ];
        const textoMostrado = valorActual ? opciones.find(o => o.valor === valorActual)?.icono || '-' : '-';
        let bgColor = '#f8f9fa';
        if (valorActual === 'verde') bgColor = '#e6f4ea';
        else if (valorActual === 'amarillo') bgColor = '#fef7e0';
        else if (valorActual === 'rojo') bgColor = '#fce8e6';
        
        let html = '<div style="position: relative; display: inline-block;">';
        html += '<button class="modern-select overall-select ' + valorActualClass + ' ' + clasesAdicionales + '" onclick="toggleCustomDropdown(\'' + dropdownId + '\', this)" style="text-align: left; border: none; background: ' + bgColor + '; padding: 6px 10px; border-radius: 16px; cursor: pointer; font-size: 20px; min-width: 50px; white-space: nowrap;">' + textoMostrado + '</button>';
        html += '<div id="' + dropdownId + '" class="custom-dropdown" style="display: none; position: absolute; top: 100%; left: 0; background: white; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.15); z-index: 10000; margin-top: 4px; overflow: hidden; min-width: 60px;">';
        opciones.forEach(opcion => {
            const isSelected = opcion.valor === valorActual;
            const onclickFunc = esSubproyecto ? 'seleccionarDropdownOptionSubproyecto' : 'seleccionarDropdownOption';
            html += '<div onclick="' + onclickFunc + '(\'' + dropdownId + '\', \'' + campo + '\', ' + idProyecto + ', \'' + opcion.valor + '\', this)" style="padding: 8px 12px; cursor: pointer; transition: background 0.2s; text-align: center; font-size: 20px; background: ' + (isSelected ? '#e8f0fe' : 'white') + '; color: ' + (isSelected ? 'var(--primary-color)' : 'var(--text-primary)') + '; white-space: nowrap;" onmouseover="this.style.background=\'#f1f3f4\'" onmouseout="this.style.background=\'' + (isSelected ? '#e8f0fe' : 'white') + '\'">' + opcion.icono + '</div>';
        });
        html += '</div></div>';
        return html;
    }

    function crearDropdownIconos(idProyecto, campo, valorActual, tipo, clasesAdicionales) {
        const dropdownId = 'dropdown-' + campo + '-' + idProyecto;
        let opciones = [];
        if (tipo === 'demanda') {
            opciones = [
                { valor: '', texto: '-', icono: '-' },
                { valor: 'llama', texto: 'üî•', icono: 'üî•' },
                { valor: 'congelado', texto: '‚ùÑÔ∏è', icono: '‚ùÑÔ∏è' },
                { valor: 'herramientas', texto: 'üîß', icono: 'üîß' },
                { valor: 'palmera', texto: 'üå¥', icono: 'üå¥' }
            ];
        } else if (tipo === 'estabilidad') {
            opciones = [
                { valor: '', texto: '-', icono: '-' },
                { valor: 'llama', texto: 'üî•', icono: 'üî•' },
                { valor: 'herramientas', texto: 'üîß', icono: 'üîß' },
                { valor: 'cohete', texto: 'üöÄ', icono: 'üöÄ' }
            ];
        }
        const textoMostrado = valorActual ? opciones.find(o => o.valor === valorActual)?.icono || '-' : '-';
        const valorActualClass = valorActual ? tipo + '-' + valorActual : '';
        
        let html = '<div style="position: relative; display: inline-block;">';
        html += '<button class="modern-select icon-select ' + valorActualClass + ' ' + clasesAdicionales + '" onclick="toggleCustomDropdown(\'' + dropdownId + '\', this)" style="text-align: left; border: none; background: #f8f9fa; padding: 6px 10px; border-radius: 16px; cursor: pointer; font-size: 20px; min-width: 50px; white-space: nowrap;">' + textoMostrado + '</button>';
        html += '<div id="' + dropdownId + '" class="custom-dropdown" style="display: none; position: absolute; top: 100%; left: 0; background: white; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.15); z-index: 10000; margin-top: 4px; overflow: hidden; min-width: 60px;">';
        opciones.forEach(opcion => {
            const isSelected = opcion.valor === valorActual;
            html += '<div onclick="seleccionarDropdownOption(\'' + dropdownId + '\', \'' + campo + '\', ' + idProyecto + ', \'' + opcion.valor + '\', this)" style="padding: 8px 12px; cursor: pointer; transition: background 0.2s; text-align: center; font-size: 20px; background: ' + (isSelected ? '#e8f0fe' : 'white') + '; color: ' + (isSelected ? 'var(--primary-color)' : 'var(--text-primary)') + '; white-space: nowrap;" onmouseover="this.style.background=\'#f1f3f4\'" onmouseout="this.style.background=\'' + (isSelected ? '#e8f0fe' : 'white') + '\'">' + opcion.icono + '</div>';
        });
        html += '</div></div>';
        return html;
    }

    function crearDropdownCaras(idProyecto, campo, valorActual, clasesAdicionales) {
        const dropdownId = 'dropdown-' + campo + '-' + idProyecto;
        const opciones = [
            { valor: '', texto: '-', icono: '-' },
            { valor: 'feliz', texto: 'üòÑ', icono: 'üòÑ' },
            { valor: 'buena', texto: 'üòä', icono: 'üòä' },
            { valor: 'regular', texto: 'üòê', icono: 'üòê' },
            { valor: 'mala', texto: 'üòû', icono: 'üòû' },
            { valor: 'enojado', texto: 'üò†', icono: 'üò†' },
            { valor: 'calavera', texto: 'üíÄ', icono: 'üíÄ' }
        ];
        const textoMostrado = valorActual ? opciones.find(o => o.valor === valorActual)?.icono || '-' : '-';
        const valorActualClass = valorActual ? 'satisfaccion-' + valorActual : '';
        
        let html = '<div style="position: relative; display: inline-block;">';
        html += '<button class="modern-select face-select ' + valorActualClass + ' ' + clasesAdicionales + '" onclick="toggleCustomDropdown(\'' + dropdownId + '\', this)" style="text-align: left; border: none; background: ' + (valorActualClass === 'satisfaccion-calavera' ? '#000000' : '#f8f9fa') + '; padding: 6px 10px; border-radius: 16px; cursor: pointer; font-size: 20px; min-width: 50px; white-space: nowrap; color: ' + (valorActualClass === 'satisfaccion-calavera' ? '#ffffff' : 'var(--text-primary)') + ';">' + textoMostrado + '</button>';
        html += '<div id="' + dropdownId + '" class="custom-dropdown" style="display: none; position: absolute; top: 100%; left: 0; background: white; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.15); z-index: 10000; margin-top: 4px; overflow: hidden; min-width: 60px;">';
        opciones.forEach(opcion => {
            const isSelected = opcion.valor === valorActual;
            html += '<div onclick="seleccionarDropdownOption(\'' + dropdownId + '\', \'' + campo + '\', ' + idProyecto + ', \'' + opcion.valor + '\', this)" style="padding: 8px 12px; cursor: pointer; transition: background 0.2s; text-align: center; font-size: 20px; background: ' + (isSelected ? '#e8f0fe' : 'white') + '; color: ' + (isSelected ? 'var(--primary-color)' : 'var(--text-primary)') + '; white-space: nowrap;" onmouseover="this.style.background=\'#f1f3f4\'" onmouseout="this.style.background=\'' + (isSelected ? '#e8f0fe' : 'white') + '\'">' + opcion.icono + '</div>';
        });
        html += '</div></div>';
        return html;
    }

    function crearDropdownEstado(idProyecto, valorActual, clasesAdicionales) {
        // Verificar si clasesAdicionales contiene 'subproyecto' (puede tener m√∫ltiples clases separadas por espacio)
        const esSubproyecto = clasesAdicionales && clasesAdicionales.includes('subproyecto');
        // Usar prefijo diferente para subproyectos para evitar colisiones de IDs
        const dropdownId = esSubproyecto ? 'dropdown-estado-sub-' + idProyecto : 'dropdown-estado-' + idProyecto;
        
        // Debug logging
        if (esSubproyecto) {
            console.log('üîµ crearDropdownEstado para SUBPROYECTO - idProyecto:', idProyecto, 'dropdownId:', dropdownId, 'clasesAdicionales:', clasesAdicionales);
        }
        const opciones = [
            { valor: '', texto: '-', label: '-' },
            { valor: 'sin comenzar', texto: 'Sin comenzar', label: 'Sin comenzar' },
            { valor: 'en curso', texto: 'En curso', label: 'En curso' },
            { valor: 'Testing', texto: 'Testing', label: 'Testing' },
            { valor: 'Entregado', texto: 'Entregado', label: 'Entregado' },
            { valor: 'Cerrado', texto: 'Cerrado', label: 'Cerrado' },
            { valor: 'Rework', texto: 'Rework', label: 'Rework' },
            { valor: 'Bloqueado', texto: 'Bloqueado', label: 'Bloqueado' }
        ];
        const textoMostrado = valorActual ? opciones.find(o => o.valor === valorActual)?.label || '-' : '-';
        let estadoClass = '';
        if (valorActual === 'Entregado' || valorActual === 'Cerrado') {
            estadoClass = 'estado-entregado';
        } else if (valorActual === 'sin comenzar') {
            estadoClass = 'estado-sin-comenzar';
        } else if (valorActual === 'en curso') {
            estadoClass = 'estado-progreso';
        } else if (valorActual === 'Testing') {
            estadoClass = 'estado-testing';
        } else if (valorActual === 'Rework') {
            estadoClass = 'estado-rework';
        } else if (valorActual === 'Bloqueado') {
            estadoClass = 'estado-bloqueado';
        }
        
        let html = '<div style="position: relative; display: inline-block;">';
        html += '<button class="modern-select estado-select ' + estadoClass + ' ' + clasesAdicionales + '" onclick="toggleCustomDropdown(\'' + dropdownId + '\', this)" style="text-align: left; border: none; padding: 6px 10px; border-radius: 16px; cursor: pointer; font-size: 13px; font-weight: 400; font-family: \'Google Sans\', \'Roboto\', sans-serif; min-width: 100px; white-space: nowrap;">' + textoMostrado + '</button>';
        html += '<div id="' + dropdownId + '" class="custom-dropdown" style="display: none; position: absolute; top: 100%; left: 0; background: white; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.15); z-index: 10000; margin-top: 4px; overflow: hidden; min-width: 120px;">';
        opciones.forEach(opcion => {
            const isSelected = opcion.valor === valorActual;
            const onclickFunc = esSubproyecto ? 'seleccionarDropdownEstadoSubproyecto' : 'seleccionarDropdownEstado';
            
            // Debug logging para subproyectos
            if (esSubproyecto) {
                console.log('üîµ Generando opci√≥n de dropdown SUBPROYECTO - onclickFunc:', onclickFunc, 'idProyecto:', idProyecto);
            }
            
            html += '<div onclick="' + onclickFunc + '(\'' + dropdownId + '\', ' + idProyecto + ', \'' + opcion.valor + '\', this)" style="padding: 8px 12px; cursor: pointer; transition: background 0.2s; text-align: center; font-size: 13px; background: ' + (isSelected ? '#e8f0fe' : 'white') + '; color: ' + (isSelected ? 'var(--primary-color)' : 'var(--text-primary)') + '; white-space: nowrap;" onmouseover="this.style.background=\'#f1f3f4\'" onmouseout="this.style.background=\'' + (isSelected ? '#e8f0fe' : 'white') + '\'">' + opcion.label + '</div>';
        });
        html += '</div></div>';
        return html;
    }

    function crearDropdownRiesgo(idProyecto, valorActual, clasesAdicionales) {
        // Verificar si clasesAdicionales contiene 'subproyecto' (puede tener m√∫ltiples clases separadas por espacio)
        const esSubproyecto = clasesAdicionales && clasesAdicionales.includes('subproyecto');
        // Usar prefijo diferente para subproyectos para evitar colisiones de IDs
        const dropdownId = esSubproyecto ? 'dropdown-riesgos-sub-' + idProyecto : 'dropdown-riesgos-' + idProyecto;
        const opciones = [
            { valor: '', texto: '-', icono: '-' },
            { valor: 'ok', texto: '‚úì', icono: '‚úì' },
            { valor: 'red flag', texto: 'üö©', icono: 'üö©' }
        ];
        const textoMostrado = valorActual ? opciones.find(o => o.valor === valorActual || (valorActual === 'okey' && o.valor === 'ok') || (valorActual === 'redflag' && o.valor === 'red flag'))?.icono || '-' : '-';
        let riesgoClass = '';
        if (valorActual === 'ok' || valorActual === 'okey') {
            riesgoClass = 'riesgo-ok';
        } else if (valorActual === 'red flag' || valorActual === 'redflag') {
            riesgoClass = 'riesgo-red';
        }
        
        let html = '<div style="position: relative; display: inline-block;">';
        html += '<button class="modern-select riesgo-select ' + riesgoClass + ' ' + clasesAdicionales + '" onclick="toggleCustomDropdown(\'' + dropdownId + '\', this)" style="text-align: left; border: none; background: #f8f9fa; padding: 6px 10px; border-radius: 16px; cursor: pointer; font-size: 20px; min-width: 50px; white-space: nowrap;">' + textoMostrado + '</button>';
        html += '<div id="' + dropdownId + '" class="custom-dropdown" style="display: none; position: absolute; top: 100%; left: 0; background: white; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.15); z-index: 10000; margin-top: 4px; overflow: hidden; min-width: 60px;">';
        opciones.forEach(opcion => {
            const isSelected = opcion.valor === valorActual || (valorActual === 'okey' && opcion.valor === 'ok') || (valorActual === 'redflag' && opcion.valor === 'red flag');
            const onclickFunc = esSubproyecto ? 'seleccionarDropdownRiesgoSubproyecto' : 'seleccionarDropdownRiesgo';
            html += '<div onclick="' + onclickFunc + '(\'' + dropdownId + '\', ' + idProyecto + ', \'' + opcion.valor + '\', this)" style="padding: 8px 12px; cursor: pointer; transition: background 0.2s; text-align: center; font-size: 20px; background: ' + (isSelected ? '#e8f0fe' : 'white') + '; color: ' + (isSelected ? 'var(--primary-color)' : 'var(--text-primary)') + '; white-space: nowrap;" onmouseover="this.style.background=\'#f1f3f4\'" onmouseout="this.style.background=\'' + (isSelected ? '#e8f0fe' : 'white') + '\'">' + opcion.icono + '</div>';
        });
        html += '</div></div>';
        return html;
    }

    // Funciones para manejar los dropdowns personalizados
    function toggleCustomDropdown(dropdownId, button) {
        const dropdown = document.getElementById(dropdownId);
        if (!dropdown) return;
        
        // Cerrar todos los otros dropdowns
        document.querySelectorAll('.custom-dropdown').forEach(dd => {
            if (dd.id !== dropdownId) {
                dd.style.display = 'none';
            }
        });
        
        const isVisible = dropdown.style.display === 'block';
        if (isVisible) {
            dropdown.style.display = 'none';
        } else {
            const rect = button.getBoundingClientRect();
            dropdown.style.position = 'fixed';
            dropdown.style.top = (rect.bottom + 4) + 'px';
            dropdown.style.left = rect.left + 'px';
            dropdown.style.width = rect.width + 'px';
            dropdown.style.zIndex = '10000';
            dropdown.style.display = 'block';
        }
    }

    function seleccionarDropdownOption(dropdownId, campo, idProyecto, valor, elemento) {
        const dropdown = document.getElementById(dropdownId);
        const button = dropdown.previousElementSibling;
        
        // Actualizar el bot√≥n
        const opciones = Array.from(dropdown.children);
        opciones.forEach(op => {
            op.style.background = 'white';
            op.style.color = 'var(--text-primary)';
        });
        elemento.style.background = '#e8f0fe';
        elemento.style.color = 'var(--primary-color)';
        
        // Cerrar dropdown
        dropdown.style.display = 'none';
        
        // Actualizar valor
        if (campo === 'overall' || campo === 'alcance' || campo === 'costo' || campo === 'plazos') {
            actualizarProyecto(idProyecto, campo, valor);
            // Actualizar clase del bot√≥n
            button.className = 'modern-select overall-select ' + (valor ? 'color-' + valor : '');
            button.textContent = valor === 'verde' ? 'üü¢' : valor === 'amarillo' ? 'üü°' : valor === 'rojo' ? 'üî¥' : '-';
            // Actualizar color de fondo
            if (valor === 'verde') button.style.background = '#e6f4ea';
            else if (valor === 'amarillo') button.style.background = '#fef7e0';
            else if (valor === 'rojo') button.style.background = '#fce8e6';
            else button.style.background = '#f8f9fa';
        } else if (campo === 'estado') {
            actualizarMantenimiento(idProyecto, campo, valor);
            // Actualizar clase del bot√≥n
            button.className = 'modern-select overall-select ' + (valor ? 'color-' + valor : '');
            button.textContent = valor === 'verde' ? 'üü¢' : valor === 'amarillo' ? 'üü°' : valor === 'rojo' ? 'üî¥' : '-';
            // Actualizar color de fondo
            if (valor === 'verde') button.style.background = '#e6f4ea';
            else if (valor === 'amarillo') button.style.background = '#fef7e0';
            else if (valor === 'rojo') button.style.background = '#fce8e6';
            else button.style.background = '#f8f9fa';
        } else if (campo === 'demanda' || campo === 'estabilidad') {
            actualizarMantenimiento(idProyecto, campo, valor);
            // Actualizar clase del bot√≥n
            const tipo = campo === 'demanda' ? 'demanda' : 'estabilidad';
            button.className = 'modern-select icon-select ' + (valor ? tipo + '-' + valor : '');
            const iconos = {
                'demanda': { 'llama': 'üî•', 'congelado': '‚ùÑÔ∏è', 'herramientas': 'üîß', 'palmera': 'üå¥' },
                'estabilidad': { 'llama': 'üî•', 'herramientas': 'üîß', 'cohete': 'üöÄ' }
            };
            button.textContent = valor ? (iconos[tipo][valor] || '-') : '-';
        } else if (campo === 'satisfaccion') {
            actualizarMantenimiento(idProyecto, campo, valor);
            // Actualizar clase del bot√≥n
            button.className = 'modern-select face-select ' + (valor ? 'satisfaccion-' + valor : '');
            const caras = { 'feliz': 'üòÑ', 'buena': 'üòä', 'regular': 'üòê', 'mala': 'üòû', 'enojado': 'üò†', 'calavera': 'üíÄ' };
            button.textContent = valor ? (caras[valor] || '-') : '-';
            if (valor === 'calavera') {
                button.style.background = '#000000';
                button.style.color = '#ffffff';
            } else {
                button.style.background = '#f8f9fa';
                button.style.color = 'var(--text-primary)';
            }
        }
    }

    function seleccionarDropdownEstado(dropdownId, idProyecto, valor, elemento) {
        console.log('üü¢ seleccionarDropdownEstado llamado - dropdownId:', dropdownId, 'idProyecto:', idProyecto, 'valor:', valor);
        
        // Verificar si este dropdown es de un subproyecto (tiene el prefijo -sub-)
        if (dropdownId && dropdownId.includes('-sub-')) {
            console.warn('‚ö†Ô∏è Dropdown de subproyecto detectado en seleccionarDropdownEstado, redirigiendo a seleccionarDropdownEstadoSubproyecto');
            // Extraer el id_subproyecto del dropdownId
            const idSubproyecto = parseInt(dropdownId.split('-sub-')[1]);
            return seleccionarDropdownEstadoSubproyecto(dropdownId, idSubproyecto, valor, elemento);
        }
        
        const dropdown = document.getElementById(dropdownId);
        const button = dropdown.previousElementSibling;
        
        // Actualizar el bot√≥n
        const opciones = Array.from(dropdown.children);
        opciones.forEach(op => {
            op.style.background = 'white';
            op.style.color = 'var(--text-primary)';
        });
        elemento.style.background = '#e8f0fe';
        elemento.style.color = 'var(--primary-color)';
        
        // Cerrar dropdown
        dropdown.style.display = 'none';
        
        // Actualizar valor
        console.log('üü¢ Llamando a actualizarProyecto con id_proyecto:', idProyecto);
        actualizarProyecto(idProyecto, 'estado', valor);
        
        // Actualizar texto del bot√≥n
        const estados = {
            '': '-',
            'sin comenzar': 'Sin comenzar',
            'en curso': 'En curso',
            'Testing': 'Testing',
            'Entregado': 'Entregado',
            'Cerrado': 'Cerrado',
            'Rework': 'Rework',
            'Bloqueado': 'Bloqueado'
        };
        button.textContent = estados[valor] || '-';
        
        // Actualizar color del bot√≥n basado en el valor
        actualizarEstadoColor(button, valor);
    }

    function seleccionarDropdownRiesgo(dropdownId, idProyecto, valor, elemento) {
        const dropdown = document.getElementById(dropdownId);
        const button = dropdown.previousElementSibling;
        
        // Actualizar el bot√≥n
        const opciones = Array.from(dropdown.children);
        opciones.forEach(op => {
            op.style.background = 'white';
            op.style.color = 'var(--text-primary)';
        });
        elemento.style.background = '#e8f0fe';
        elemento.style.color = 'var(--primary-color)';
        
        // Cerrar dropdown
        dropdown.style.display = 'none';
        
        // Actualizar valor
        actualizarProyecto(idProyecto, 'riesgos', valor);
        actualizarRiesgoColor(button);
        
        // Actualizar texto del bot√≥n
        button.textContent = valor === 'ok' ? '‚úì' : valor === 'red flag' ? 'üö©' : '-';
    }
    
    // Funciones para subproyectos
    function seleccionarDropdownOptionSubproyecto(dropdownId, campo, idSubproyecto, valor, elemento) {
        const dropdown = document.getElementById(dropdownId);
        const button = dropdown.previousElementSibling;
        
        // Actualizar el bot√≥n
        const opciones = Array.from(dropdown.children);
        opciones.forEach(op => {
            op.style.background = 'white';
            op.style.color = 'var(--text-primary)';
        });
        elemento.style.background = '#e8f0fe';
        elemento.style.color = 'var(--primary-color)';
        
        // Cerrar dropdown
        dropdown.style.display = 'none';
        
        // Actualizar valor
        if (campo === 'overall' || campo === 'alcance' || campo === 'costo' || campo === 'plazos') {
            actualizarSubproyecto(idSubproyecto, campo, valor);
            // Actualizar clase del bot√≥n
            button.className = 'modern-select overall-select ' + (valor ? 'color-' + valor : '');
            button.textContent = valor === 'verde' ? 'üü¢' : valor === 'amarillo' ? 'üü°' : valor === 'rojo' ? 'üî¥' : '-';
            // Actualizar color de fondo
            if (valor === 'verde') button.style.background = '#e6f4ea';
            else if (valor === 'amarillo') button.style.background = '#fef7e0';
            else if (valor === 'rojo') button.style.background = '#fce8e6';
            else button.style.background = '#f8f9fa';
        }
    }
    
    function seleccionarDropdownEstadoSubproyecto(dropdownId, idSubproyecto, valor, elemento) {
        console.log('üîµ seleccionarDropdownEstadoSubproyecto llamado - dropdownId:', dropdownId, 'idSubproyecto:', idSubproyecto, 'valor:', valor);
        
        const dropdown = document.getElementById(dropdownId);
        if (!dropdown) {
            console.error('‚ùå Dropdown no encontrado:', dropdownId);
            return;
        }
        const button = dropdown.previousElementSibling;
        
        // Actualizar el bot√≥n
        const opciones = Array.from(dropdown.children);
        opciones.forEach(op => {
            op.style.background = 'white';
            op.style.color = 'var(--text-primary)';
        });
        elemento.style.background = '#e8f0fe';
        elemento.style.color = 'var(--primary-color)';
        
        // Cerrar dropdown
        dropdown.style.display = 'none';
        
        // Actualizar valor - Asegurarse de que se llama a actualizarSubproyecto, no a actualizarProyecto
        console.log('üîµ Llamando a actualizarSubproyecto con id_subproyecto:', idSubproyecto);
        actualizarSubproyecto(idSubproyecto, 'estado', valor);
        
        // Actualizar texto del bot√≥n
        const estados = {
            '': '-',
            'sin comenzar': 'Sin comenzar',
            'en curso': 'En curso',
            'Testing': 'Testing',
            'Entregado': 'Entregado',
            'Cerrado': 'Cerrado',
            'Rework': 'Rework',
            'Bloqueado': 'Bloqueado'
        };
        button.textContent = estados[valor] || '-';
        
        // Actualizar color del bot√≥n basado en el valor
        actualizarEstadoColor(button, valor);
    }
    
    function seleccionarDropdownRiesgoSubproyecto(dropdownId, idSubproyecto, valor, elemento) {
        const dropdown = document.getElementById(dropdownId);
        const button = dropdown.previousElementSibling;
        
        // Actualizar el bot√≥n
        const opciones = Array.from(dropdown.children);
        opciones.forEach(op => {
            op.style.background = 'white';
            op.style.color = 'var(--text-primary)';
        });
        elemento.style.background = '#e8f0fe';
        elemento.style.color = 'var(--primary-color)';
        
        // Cerrar dropdown
        dropdown.style.display = 'none';
        
        // Actualizar valor
        actualizarSubproyecto(idSubproyecto, 'riesgos', valor);
        actualizarRiesgoColor(button);
        
        // Actualizar texto del bot√≥n
        button.textContent = valor === 'ok' ? '‚úì' : valor === 'red flag' ? 'üö©' : '-';
    }

    // Cerrar dropdowns al hacer click fuera
    document.addEventListener('click', (e) => {
        if (!e.target.closest('.custom-dropdown') && !e.target.closest('button[onclick*="toggleCustomDropdown"]')) {
            document.querySelectorAll('.custom-dropdown').forEach(dd => {
                dd.style.display = 'none';
            });
        }
    });

    // Cargar datos al iniciar
    document.addEventListener('DOMContentLoaded', () => {
        if (productoActual) {
            cargarDatos();
            if (tipoActual === 'proyectos') {
                cargarClientesParaFiltro();
            }
        } else {
            mostrarDashboard();
        }
    });

    async function mostrarDashboard() {
        const contenido = document.getElementById('contenido');
        const productosEquipos = <%- JSON.stringify(productosEquipos) %>;
        
        // Mostrar loading
        contenido.innerHTML = '<div class="empty-state"><div class="spinner"></div><div class="empty-state-text">Cargando m√©tricas...</div></div>';
        
        try {
            // Obtener m√©tricas del dashboard
            const response = await fetch('/api/dashboard/metricas');
            const result = await response.json();
            
            if (!result.success) {
                throw new Error(result.error || 'Error al cargar m√©tricas');
            }
            
            const metricas = result.data || [];
            
            // Crear un mapa de m√©tricas por producto
            const metricasMap = {};
            metricas.forEach(m => {
                metricasMap[m.producto] = m;
            });
            
            let dashboardHTML = '<div style="padding: 24px;">';
            dashboardHTML += '<div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(400px, 1fr)); gap: 24px;">';
            
            productosEquipos.forEach(function(item) {
                const producto = item.producto;
                const productoNormalizado = producto === 'OMS' ? 'Order Management' : producto;
                const equipos = item.equipos || [];
                const metrica = metricasMap[producto] || { total_equipos: 0, total_clientes: 0, proyectos_en_curso: 0 };
                
                dashboardHTML += '<div style="background: white; border-radius: 12px; padding: 32px; box-shadow: 0 1px 2px 0 rgba(60,64,67,.3), 0 1px 3px 1px rgba(60,64,67,.15);">';
                dashboardHTML += '<h3 style="font-size: 20px; font-weight: 500; color: var(--text-primary); margin-bottom: 24px; font-family: \'Google Sans\', \'Roboto\', sans-serif;">' + productoNormalizado + '</h3>';
                
                // Equipos
                if (equipos.length > 0) {
                    dashboardHTML += '<div style="margin-bottom: 20px;">';
                    dashboardHTML += '<div style="font-size: 13px; font-weight: 500; color: var(--text-secondary); margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.5px;">Equipos (' + equipos.length + ')</div>';
                    dashboardHTML += '<div style="display: flex; flex-wrap: wrap; gap: 8px;">';
                    equipos.forEach(function(equipo) {
                        dashboardHTML += '<span style="display: inline-block; padding: 6px 12px; background: #e8f0fe; color: var(--primary-color); border-radius: 16px; font-size: 13px; font-weight: 500;">' + equipo.equipo + '</span>';
                    });
                    dashboardHTML += '</div>';
                    dashboardHTML += '</div>';
                }
                
                // M√©tricas
                dashboardHTML += '<div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px; margin-top: 20px;">';
                
                // Total Clientes
                dashboardHTML += '<div style="padding: 16px; background: #f8f9fa; border-radius: 8px;">';
                dashboardHTML += '<div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 4px; text-transform: uppercase; letter-spacing: 0.5px;">Total Clientes</div>';
                dashboardHTML += '<div style="font-size: 28px; font-weight: 600; color: var(--text-primary);">' + parseInt(metrica.total_clientes || 0) + '</div>';
                dashboardHTML += '</div>';
                
                // Proyectos en Curso
                dashboardHTML += '<div style="padding: 16px; background: #f8f9fa; border-radius: 8px;">';
                dashboardHTML += '<div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 4px; text-transform: uppercase; letter-spacing: 0.5px;">Proyectos en Curso</div>';
                dashboardHTML += '<div style="font-size: 28px; font-weight: 600; color: var(--text-primary);">' + parseInt(metrica.proyectos_en_curso || 0) + '</div>';
                dashboardHTML += '</div>';
                
                dashboardHTML += '</div>'; // Cierre grid m√©tricas
                dashboardHTML += '</div>'; // Cierre card
            });
            
            dashboardHTML += '</div>'; // Cierre grid
            dashboardHTML += '</div>'; // Cierre padding
            
            contenido.innerHTML = dashboardHTML;
        } catch (error) {
            console.error('Error al cargar m√©tricas:', error);
            contenido.innerHTML = '<div class="empty-state"><div class="empty-state-text">Error al cargar m√©tricas</div><div class="empty-state-subtext">' + error.message + '</div></div>';
        }
    }

    async function cargarClientesParaFiltro() {
        // Esta funci√≥n se mantiene para compatibilidad, pero ahora usa actualizarFiltroClientesDesdeTabla
        actualizarFiltroClientesDesdeTabla();
    }

    function actualizarFiltroClientesDesdeTabla() {
        try {
            // Usar los datos de la tabla actual en lugar de hacer una consulta separada
            const clientes = [...new Set(datosTablaActual.map(p => p.cliente).filter(c => c))].sort();
            const filterClientes = document.getElementById('filterClientes');
            if (filterClientes) {
                let html = '<div style="padding: 8px 16px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center;">';
                html += '<button onclick="seleccionarTodosClientes()" style="background: none; border: none; color: var(--primary-color); font-size: 13px; font-weight: 500; cursor: pointer; padding: 4px 8px;">Todos</button>';
                html += '<button onclick="deseleccionarTodosClientes()" style="background: none; border: none; color: var(--text-secondary); font-size: 13px; cursor: pointer; padding: 4px 8px;">Borrar todos</button>';
                html += '</div>';
                html += clientes.map(cliente => `
                    <label style="display: flex; align-items: center; padding: 10px 16px; cursor: pointer; transition: background 0.2s;" 
                           onmouseover="this.style.background='#f1f3f4'" 
                           onmouseout="this.style.background='white'">
                        <input type="checkbox" class="filter-checkbox-cliente" value="${cliente}" style="margin-right: 8px; cursor: pointer;" onchange="aplicarFiltrosProyectos()" />
                        <span style="font-size: 13px;">${cliente}</span>
                    </label>
                `).join('');
                filterClientes.innerHTML = html;
            }
        } catch (error) {
            console.error('Error al actualizar filtro de clientes:', error);
        }
    }

    async function cargarDatos() {
        const contenido = document.getElementById('contenido');
        contenido.innerHTML = '<div class="empty-state"><div class="spinner"></div><div class="empty-state-text">Cargando datos...</div></div>';

        try {
            let endpoint = '';
            let params = 'producto=' + encodeURIComponent(productoActual);
            if (equipoActual) {
                params += '&equipo=' + encodeURIComponent(equipoActual);
            }
            if (busquedaActual) {
                params += '&busqueda=' + encodeURIComponent(busquedaActual);
            }
            
            if (tipoActual === 'mantenimiento') {
                endpoint = '/api/mantenimiento?' + params;
            } else if (tipoActual === 'proyectos') {
                endpoint = '/api/proyectos?' + params;
            }

            // Agregar timeout de 30 segundos
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 30000);

            let response;
            try {
                response = await fetch(endpoint, { signal: controller.signal });
            } catch (fetchError) {
                clearTimeout(timeoutId);
                if (fetchError.name === 'AbortError') {
                    throw new Error('La solicitud tard√≥ demasiado tiempo. Verifica tu conexi√≥n a internet o el estado del servidor.');
                } else if (fetchError.message.includes('Failed to fetch') || fetchError.message.includes('NetworkError')) {
                    throw new Error('Error de conexi√≥n con el servidor. Verifica tu conexi√≥n a internet o que el servidor est√© funcionando.');
                } else {
                    throw new Error('Error al conectar con el servidor: ' + fetchError.message);
                }
            }
            clearTimeout(timeoutId);

            // Verificar si la respuesta es OK
            if (!response.ok) {
                const errorText = await response.text();
                let errorMessage = 'Error del servidor';
                try {
                    const errorJson = JSON.parse(errorText);
                    errorMessage = errorJson.error || errorMessage;
                } catch (e) {
                    errorMessage = `Error HTTP ${response.status}: ${response.statusText}`;
                }
                throw new Error(errorMessage);
            }

            const result = await response.json();

            // Verificar si la respuesta indica error
            if (!result.success) {
                throw new Error(result.error || 'Error al obtener los datos');
            }

            // Verificar si result.data existe
            if (!result.data) {
                throw new Error('No se recibieron datos del servidor');
            }

            if (result.data.length > 0) {
                let datosFiltrados = result.data;
                
                // Guardar datos originales (sin filtros de clientes/estados) para el filtro de clientes
                if (tipoActual === 'proyectos') {
                    datosOriginales = result.data;
                    // Aplicar solo el filtro de cerrados a los datos originales para el filtro de clientes
                    const incluirCerrados = document.getElementById('incluirCerrados')?.checked || false;
                    let datosParaFiltro = [...datosOriginales];
                    if (!incluirCerrados) {
                        datosParaFiltro = datosParaFiltro.filter(d => (d.estado || '').toLowerCase() !== 'cerrado');
                    }
                    // Actualizar filtro de clientes con los datos disponibles (sin filtros de clientes/estados)
                    datosTablaActual = datosParaFiltro;
                    actualizarFiltroClientesDesdeTabla();
                }
                
                // Aplicar filtros de clientes y estados para proyectos
                if (tipoActual === 'proyectos') {
                    if (filtrosClientes.length > 0) {
                        datosFiltrados = datosFiltrados.filter(d => filtrosClientes.includes(d.cliente));
                    }
                    if (filtrosEstados.length > 0) {
                        datosFiltrados = datosFiltrados.filter(d => filtrosEstados.includes(d.estado));
                    }
                    // Filtrar cerrados: por defecto excluir, a menos que el checkbox est√© activado
                    const incluirCerrados = document.getElementById('incluirCerrados')?.checked || false;
                    if (!incluirCerrados) {
                        datosFiltrados = datosFiltrados.filter(d => (d.estado || '').toLowerCase() !== 'cerrado');
                    }
                    actualizarFiltrosAplicados();
                }
                
                // Ordenar por defecto: cliente (asc) y luego estado (seg√∫n orden del select)
                if (tipoActual === 'proyectos' && ordenActual.columna === 'cliente' && ordenActual.direccion === 'asc') {
                    datosFiltrados.sort((a, b) => {
                        const clienteA = (a.cliente || '').toLowerCase();
                        const clienteB = (b.cliente || '').toLowerCase();
                        if (clienteA !== clienteB) {
                            return clienteA < clienteB ? -1 : 1;
                        }
                        const indexA = ordenEstados.indexOf((a.estado || '').toLowerCase());
                        const indexB = ordenEstados.indexOf((b.estado || '').toLowerCase());
                        const estadoA = indexA === -1 ? 999 : indexA;
                        const estadoB = indexB === -1 ? 999 : indexB;
                        return estadoA - estadoB;
                    });
                }
                
                renderizarTabla(datosFiltrados);
            } else {
                datosTablaActual = [];
                datosOriginales = [];
                contenido.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üì≠</div><div class="empty-state-text">No hay datos disponibles</div><div class="empty-state-subtext">Haz clic en "Actualizar" para sincronizar</div></div>';
                // Actualizar filtro de clientes (vac√≠o) cuando no hay datos
                if (tipoActual === 'proyectos') {
                    actualizarFiltroClientesDesdeTabla();
                    // Actualizar contador de proyectos
                    const contadorProyectos = document.getElementById('contadorProyectos');
                    if (contadorProyectos) {
                        contadorProyectos.textContent = 'total proyectos: 0';
                    }
                }
            }
        } catch (error) {
            console.error('Error al cargar datos:', error);
            
            // Determinar el tipo de error y mostrar mensaje apropiado
            let mensajeError = 'Error al cargar datos';
            let mensajeDetalle = error.message || 'Error desconocido';
            
            // Detectar errores espec√≠ficos de conexi√≥n
            if (mensajeDetalle.includes('conexi√≥n') || mensajeDetalle.includes('connection') || 
                mensajeDetalle.includes('ECONNREFUSED') || mensajeDetalle.includes('timeout') ||
                mensajeDetalle.includes('NetworkError') || mensajeDetalle.includes('Failed to fetch')) {
                mensajeError = 'Error de conexi√≥n';
                mensajeDetalle = 'No se pudo conectar con el servidor. Verifica que el servidor est√© funcionando y tu conexi√≥n a internet.';
            } else if (mensajeDetalle.includes('base de datos') || mensajeDetalle.includes('database') ||
                       mensajeDetalle.includes('relation') || mensajeDetalle.includes('does not exist')) {
                mensajeError = 'Error de base de datos';
                mensajeDetalle = 'Error al conectar con la base de datos. Contacta al administrador del sistema.';
            }
            
            contenido.innerHTML = '<div class="empty-state">' +
                '<div class="empty-state-icon">‚ùå</div>' +
                '<div class="empty-state-text">' + mensajeError + '</div>' +
                '<div class="empty-state-subtext">' + mensajeDetalle + '</div>' +
                '<button class="button" onclick="cargarDatos()" style="margin-top: 16px;">Reintentar</button>' +
                '</div>';
            
            // Actualizar contador de proyectos en caso de error
            if (tipoActual === 'proyectos') {
                const contadorProyectos = document.getElementById('contadorProyectos');
                if (contadorProyectos) {
                    contadorProyectos.textContent = 'total proyectos: 0';
                }
            }
            
            // Limpiar datos de filtros cuando hay error
            datosTablaActual = [];
            datosOriginales = [];
        }
    }

    function renderizarTabla(datos) {
        const contenido = document.getElementById('contenido');
        
        if (tipoActual === 'mantenimiento') {
            let tablaHTML = '<div class="modern-table-wrapper"><div class="modern-table mantenimiento"><div class="modern-table-header" style="position: relative;">';
            tablaHTML += '<div class="modern-table-cell header-cell">Cliente</div>';
            tablaHTML += '<div class="modern-table-cell header-cell">L√≠mite Horas</div>';
            tablaHTML += '<div class="modern-table-cell header-cell">Overall</div>';
            tablaHTML += '<div class="modern-table-cell header-cell">Demanda</div>';
            tablaHTML += '<div class="modern-table-cell header-cell">Estabilidad</div>';
            tablaHTML += '<div class="modern-table-cell header-cell">Satisfacci√≥n</div>';
            tablaHTML += '<div class="modern-table-cell header-cell" style="flex: 1;">WIN</div>';
            tablaHTML += '<button onclick="sincronizar()" style="position: absolute; right: 16px; top: 50%; transform: translateY(-50%); display: flex; align-items: center; justify-content: center; width: 40px; height: 40px; border-radius: 50%; border: 1px solid #dfe1e5; background: white; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background=\'#f1f3f4\'" onmouseout="this.style.background=\'white\'" title="Actualizar mantenimiento">';
            tablaHTML += '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="currentColor" style="color: #5f6368;">';
            tablaHTML += '<path d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/>';
            tablaHTML += '</svg></button>';
            tablaHTML += '</div>';
            
            datos.forEach(function(item) {
                tablaHTML += '<div class="modern-table-row">';
                tablaHTML += '<div class="modern-table-cell item-text">' + (item.cliente || '-') + '</div>';
                tablaHTML += '<div class="modern-table-cell item-text">' + (item.limite_horas || '-') + '</div>';
                const estadoValue = item.estado || '';
                tablaHTML += '<div class="modern-table-cell">' + crearDropdownOverall(item.id_proyecto, 'estado', estadoValue, '') + '</div>';
                
                const demandaValue = item.demanda || '';
                tablaHTML += '<div class="modern-table-cell">' + crearDropdownIconos(item.id_proyecto, 'demanda', demandaValue, 'demanda', '') + '</div>';
                
                const estabilidadValue = item.estabilidad || '';
                tablaHTML += '<div class="modern-table-cell">' + crearDropdownIconos(item.id_proyecto, 'estabilidad', estabilidadValue, 'estabilidad', '') + '</div>';
                
                const satisfaccionValue = item.satisfaccion || '';
                tablaHTML += '<div class="modern-table-cell">' + crearDropdownCaras(item.id_proyecto, 'satisfaccion', satisfaccionValue, '') + '</div>';
                tablaHTML += '<div class="modern-table-cell"><textarea class="modern-input win-textarea" onchange="actualizarMantenimiento(' + item.id_proyecto + ', \'win\', this.value)">' + (item.win || '') + '</textarea></div>';
                tablaHTML += '</div>';
            });
            
            tablaHTML += '</div></div>';
            contenido.innerHTML = tablaHTML;
        } else {
            // Proyectos
            // Ordenar datos antes de renderizar
            let datosOrdenados = [...datos];
            datosOrdenados.sort((a, b) => {
                let valorA, valorB;
                
                if (ordenActual.columna === 'cliente') {
                    valorA = (a.cliente || '').toLowerCase();
                    valorB = (b.cliente || '').toLowerCase();
                } else if (ordenActual.columna === 'proyecto') {
                    valorA = (a.nombre_proyecto || '').toLowerCase();
                    valorB = (b.nombre_proyecto || '').toLowerCase();
                } else if (ordenActual.columna === 'estado') {
                    const indexA = ordenEstados.indexOf((a.estado || '').toLowerCase());
                    const indexB = ordenEstados.indexOf((b.estado || '').toLowerCase());
                    valorA = indexA === -1 ? 999 : indexA;
                    valorB = indexB === -1 ? 999 : indexB;
                    // Si tienen el mismo estado, ordenar por cliente
                    if (valorA === valorB) {
                        valorA = (a.cliente || '').toLowerCase();
                        valorB = (b.cliente || '').toLowerCase();
                    }
                } else if (ordenActual.columna === 'overall') {
                    const ordenOverall = { 'verde': 1, 'amarillo': 2, 'rojo': 3, '': 4 };
                    valorA = ordenOverall[a.overall] || 4;
                    valorB = ordenOverall[b.overall] || 4;
                } else if (ordenActual.columna === 'alcance') {
                    const ordenAlcance = { 'verde': 1, 'amarillo': 2, 'rojo': 3, '': 4 };
                    valorA = ordenAlcance[a.alcance] || 4;
                    valorB = ordenAlcance[b.alcance] || 4;
                } else if (ordenActual.columna === 'costo') {
                    const ordenCosto = { 'verde': 1, 'amarillo': 2, 'rojo': 3, '': 4 };
                    valorA = ordenCosto[a.costo] || 4;
                    valorB = ordenCosto[b.costo] || 4;
                } else if (ordenActual.columna === 'plazos') {
                    const ordenPlazos = { 'verde': 1, 'amarillo': 2, 'rojo': 3, '': 4 };
                    valorA = ordenPlazos[a.plazos] || 4;
                    valorB = ordenPlazos[b.plazos] || 4;
                } else if (ordenActual.columna === 'riesgos') {
                    const ordenRiesgos = { 'ok': 1, 'red flag': 2, '': 3 };
                    valorA = ordenRiesgos[a.riesgos] || 3;
                    valorB = ordenRiesgos[b.riesgos] || 3;
                } else if (ordenActual.columna === 'avance') {
                    valorA = parseInt(a.avance) || 0;
                    valorB = parseInt(b.avance) || 0;
                } else {
                    return 0;
                }
                
                if (valorA < valorB) return ordenActual.direccion === 'asc' ? -1 : 1;
                if (valorA > valorB) return ordenActual.direccion === 'asc' ? 1 : -1;
                // Si son iguales, ordenar por cliente y luego por estado
                if (ordenActual.columna !== 'cliente' && ordenActual.columna !== 'estado') {
                    const clienteA = (a.cliente || '').toLowerCase();
                    const clienteB = (b.cliente || '').toLowerCase();
                    if (clienteA !== clienteB) {
                        return clienteA < clienteB ? -1 : 1;
                    }
                    const indexA = ordenEstados.indexOf((a.estado || '').toLowerCase());
                    const indexB = ordenEstados.indexOf((b.estado || '').toLowerCase());
                    const estadoA = indexA === -1 ? 999 : indexA;
                    const estadoB = indexB === -1 ? 999 : indexB;
                    return estadoA - estadoB;
                }
                return 0;
            });
            
            let tablaHTML = '<div class="modern-table-wrapper"><div class="modern-table proyectos"><div class="modern-table-header">';
            const flechaAsc = '‚ñ≤';
            const flechaDesc = '‚ñº';
            // Agregar columna para la flecha de expandir/contraer
            tablaHTML += '<div class="modern-table-cell header-cell" style="width: 40px;"></div>';
            tablaHTML += '<div class="modern-table-cell header-cell" onclick="ordenarPor(\'cliente\')" style="cursor: pointer; user-select: none;' + (ordenActual.columna === 'cliente' ? ' color: var(--primary-color);' : '') + '">Cliente' + (ordenActual.columna === 'cliente' ? ' ' + (ordenActual.direccion === 'asc' ? flechaAsc : flechaDesc) : '') + '</div>';
            tablaHTML += '<div class="modern-table-cell header-cell" onclick="ordenarPor(\'proyecto\')" style="cursor: pointer; user-select: none;' + (ordenActual.columna === 'proyecto' ? ' color: var(--primary-color);' : '') + '">Proyecto' + (ordenActual.columna === 'proyecto' ? ' ' + (ordenActual.direccion === 'asc' ? flechaAsc : flechaDesc) : '') + '</div>';
            tablaHTML += '<div class="modern-table-cell header-cell" onclick="ordenarPor(\'estado\')" style="cursor: pointer; user-select: none;' + (ordenActual.columna === 'estado' ? ' color: var(--primary-color);' : '') + '">Estado' + (ordenActual.columna === 'estado' ? ' ' + (ordenActual.direccion === 'asc' ? flechaAsc : flechaDesc) : '') + '</div>';
            tablaHTML += '<div class="modern-table-cell header-cell" onclick="ordenarPor(\'overall\')" style="cursor: pointer; user-select: none;' + (ordenActual.columna === 'overall' ? ' color: var(--primary-color);' : '') + '">Overall' + (ordenActual.columna === 'overall' ? ' ' + (ordenActual.direccion === 'asc' ? flechaAsc : flechaDesc) : '') + '</div>';
            tablaHTML += '<div class="modern-table-cell header-cell" onclick="ordenarPor(\'alcance\')" style="cursor: pointer; user-select: none;' + (ordenActual.columna === 'alcance' ? ' color: var(--primary-color);' : '') + '">Alcance' + (ordenActual.columna === 'alcance' ? ' ' + (ordenActual.direccion === 'asc' ? flechaAsc : flechaDesc) : '') + '</div>';
            tablaHTML += '<div class="modern-table-cell header-cell" onclick="ordenarPor(\'costo\')" style="cursor: pointer; user-select: none;' + (ordenActual.columna === 'costo' ? ' color: var(--primary-color);' : '') + '">Costo' + (ordenActual.columna === 'costo' ? ' ' + (ordenActual.direccion === 'asc' ? flechaAsc : flechaDesc) : '') + '</div>';
            tablaHTML += '<div class="modern-table-cell header-cell" onclick="ordenarPor(\'plazos\')" style="cursor: pointer; user-select: none;' + (ordenActual.columna === 'plazos' ? ' color: var(--primary-color);' : '') + '">Plazos' + (ordenActual.columna === 'plazos' ? ' ' + (ordenActual.direccion === 'asc' ? flechaAsc : flechaDesc) : '') + '</div>';
            tablaHTML += '<div class="modern-table-cell header-cell" onclick="ordenarPor(\'riesgos\')" style="cursor: pointer; user-select: none;' + (ordenActual.columna === 'riesgos' ? ' color: var(--primary-color);' : '') + '">Riesgos' + (ordenActual.columna === 'riesgos' ? ' ' + (ordenActual.direccion === 'asc' ? flechaAsc : flechaDesc) : '') + '</div>';
            tablaHTML += '<div class="modern-table-cell header-cell" onclick="ordenarPor(\'avance\')" style="cursor: pointer; user-select: none;' + (ordenActual.columna === 'avance' ? ' color: var(--primary-color);' : '') + '">Avance' + (ordenActual.columna === 'avance' ? ' ' + (ordenActual.direccion === 'asc' ? flechaAsc : flechaDesc) : '') + '</div>';
            tablaHTML += '</div>';
            
            datos = datosOrdenados;
            
            // Funci√≥n para formatear fecha a YYYY-MM-DD
            function formatearFecha(fecha) {
                if (!fecha) return '';
                // Si es un objeto Date
                if (fecha instanceof Date) {
                    const year = fecha.getFullYear();
                    const month = String(fecha.getMonth() + 1).padStart(2, '0');
                    const day = String(fecha.getDate()).padStart(2, '0');
                    return year + '-' + month + '-' + day;
                }
                // Si es un string, verificar si ya est√° en formato YYYY-MM-DD
                if (typeof fecha === 'string') {
                    // Si viene como "2024-12-07T00:00:00.000Z" o similar, extraer solo la fecha
                    const match = fecha.match(/^(\d{4}-\d{2}-\d{2})/);
                    if (match) {
                        return match[1];
                    }
                    return fecha;
                }
                return '';
            }
            
            datos.forEach(function(item) {
                const redmineUrl = 'https://redmine.mercap.net/projects/' + (item.codigo_proyecto || '');
                // Truncar el nombre del proyecto: quitar lo que est√° a la izquierda de " | "
                let nombreProyecto = item.nombre_proyecto || '-';
                if (nombreProyecto.includes(' | ')) {
                    nombreProyecto = nombreProyecto.split(' | ').slice(1).join(' | ');
                }
                
                // Verificar si tiene subproyectos (pero no cargarlos todav√≠a - carga lazy)
                const tieneSecundarios = item.tiene_subproyectos || false;
                
                // Guardar datos del item para el modal
                const itemData = {
                    id_proyecto: item.id_proyecto,
                    nombre_proyecto: item.nombre_proyecto || '',
                    codigo_proyecto: item.codigo_proyecto || '',
                    horas_estimadas: parseFloat(item.horas_estimadas) || 0,
                    horas_realizadas: parseFloat(item.horas_realizadas) || 0,
                    fecha_inicio_epics: item.fecha_inicio_epics || item.fecha_inicio || '',
                    fecha_fin_epics: item.fecha_fin_epics || item.fecha_fin || '',
                    fecha_inicio: item.fecha_inicio || '',
                    fecha_fin: item.fecha_fin || '',
                    win: item.win || '',
                    tiene_epics: item.tiene_epics || false,
                    estado: item.estado || '',
                    redmineUrl: redmineUrl
                };
                const itemDataJson = JSON.stringify(itemData).replace(/"/g, '&quot;').replace(/'/g, '&#39;');
                
                // Fila del proyecto principal
                tablaHTML += '<div class="modern-table-row" data-id-proyecto="' + item.id_proyecto + '">';
                
                // Agregar flecha si tiene epics secundarios
                if (tieneSecundarios) {
                    tablaHTML += '<div class="modern-table-cell" style="width: 40px; padding: 0; text-align: center;"><button class="expand-btn" onclick="toggleProyectosSecundarios(' + item.id_proyecto + ', this)" style="background: none; border: none; cursor: pointer; padding: 8px; color: var(--text-secondary); font-size: 16px; transition: transform 0.2s;" title="Expandir/Contraer proyectos secundarios">‚ñ∂</button></div>';
                } else {
                    tablaHTML += '<div class="modern-table-cell" style="width: 40px;"></div>';
                }
                
                tablaHTML += '<div class="modern-table-cell item-text">' + (item.cliente || '-') + '</div>';
                
                // Cambiar el enlace para que abra el modal en lugar de redirigir a Redmine
                tablaHTML += '<div class="modern-table-cell item-text"><a href="javascript:void(0);" onclick="abrirModalDetalle(' + item.id_proyecto + '); event.stopPropagation();" data-item="' + itemDataJson + '" style="color: var(--primary-color); text-decoration: none; cursor: pointer;">' + nombreProyecto + '</a></div>';
                
                const estadoValue = item.estado || '';
                let estadoClass = '';
                if (estadoValue === 'Entregado' || estadoValue === 'Cerrado') {
                    estadoClass = 'estado-entregado';
                } else if (estadoValue === 'sin comenzar') {
                    estadoClass = 'estado-sin-comenzar';
                } else if (estadoValue === 'en curso') {
                    estadoClass = 'estado-progreso';
                } else if (estadoValue === 'Testing') {
                    estadoClass = 'estado-testing';
                } else if (estadoValue === 'Rework') {
                    estadoClass = 'estado-rework';
                } else if (estadoValue === 'Bloqueado') {
                    estadoClass = 'estado-bloqueado';
                }
                tablaHTML += '<div class="modern-table-cell">' + crearDropdownEstado(item.id_proyecto, estadoValue, estadoClass) + '</div>';
                
                const overallValue = item.overall || '';
                tablaHTML += '<div class="modern-table-cell">' + crearDropdownOverall(item.id_proyecto, 'overall', overallValue, '') + '</div>';
                
                const alcanceValue = item.alcance || '';
                tablaHTML += '<div class="modern-table-cell">' + crearDropdownOverall(item.id_proyecto, 'alcance', alcanceValue, '') + '</div>';
                
                const costoValue = item.costo || '';
                tablaHTML += '<div class="modern-table-cell">' + crearDropdownOverall(item.id_proyecto, 'costo', costoValue, '') + '</div>';
                
                const plazosValue = item.plazos || '';
                tablaHTML += '<div class="modern-table-cell">' + crearDropdownOverall(item.id_proyecto, 'plazos', plazosValue, '') + '</div>';
                
                const riesgoValue = item.riesgos || '';
                tablaHTML += '<div class="modern-table-cell">' + crearDropdownRiesgo(item.id_proyecto, riesgoValue, '') + '</div>';
                
                const avanceValue = parseInt(item.avance) || 0;
                let avanceGradient = 'linear-gradient(90deg, #66bb6a 0%, #34a853 100%)';
                if (avanceValue <= 25) {
                    avanceGradient = 'linear-gradient(90deg, #a5d6a7 0%, #81c784 100%)';
                } else if (avanceValue <= 50) {
                    avanceGradient = 'linear-gradient(90deg, #81c784 0%, #66bb6a 100%)';
                } else if (avanceValue <= 75) {
                    avanceGradient = 'linear-gradient(90deg, #66bb6a 0%, #4caf50 100%)';
                } else {
                    avanceGradient = 'linear-gradient(90deg, #4caf50 0%, #34a853 50%, #1e8e3e 100%)';
                }
                tablaHTML += '<div class="modern-table-cell"><div class="progress-bar-container" data-id="' + item.id_proyecto + '"><div class="progress-bar" style="width: ' + avanceValue + '%; background: ' + avanceGradient + ';"></div><input type="range" min="0" max="100" step="5" value="' + avanceValue + '" class="progress-slider" oninput="actualizarBarraProgreso(this);" onchange="actualizarProyecto(' + item.id_proyecto + ', \'avance\', this.value);" /></div></div>';
                tablaHTML += '</div>';
                
                // NO renderizar subproyectos todav√≠a - se cargar√°n bajo demanda cuando se expanda
                // Las filas de subproyectos se agregar√°n din√°micamente en toggleProyectosSecundarios
            });
            
            tablaHTML += '</div></div>';
            contenido.innerHTML = tablaHTML;
            
            // Actualizar contador de proyectos
            const contadorProyectos = document.getElementById('contadorProyectos');
            if (contadorProyectos) {
                contadorProyectos.textContent = 'Total proyectos: ' + datos.length;
            }
        }
    }

    // Throttle para mejorar performance de la barra de progreso
    let throttleTimeout = null;
    function actualizarBarraProgreso(slider) {
        if (throttleTimeout) {
            return;
        }
        throttleTimeout = requestAnimationFrame(() => {
            const container = slider.closest('.progress-bar-container');
            const bar = container.querySelector('.progress-bar');
            // Usar el valor exacto (sin redondear)
            const value = parseInt(slider.value);
            bar.style.width = value + '%';
            
            // Actualizar gradiente verde seg√∫n el valor (cambia cada 1%)
            let gradient = 'linear-gradient(90deg, #66bb6a 0%, #34a853 100%)';
            if (value <= 25) {
                gradient = 'linear-gradient(90deg, #a5d6a7 0%, #81c784 100%)';
            } else if (value <= 50) {
                gradient = 'linear-gradient(90deg, #81c784 0%, #66bb6a 100%)';
            } else if (value <= 75) {
                gradient = 'linear-gradient(90deg, #66bb6a 0%, #4caf50 100%)';
            } else {
                gradient = 'linear-gradient(90deg, #4caf50 0%, #34a853 50%, #1e8e3e 100%)';
            }
            bar.style.background = gradient;
            throttleTimeout = null;
        });
    }

    function actualizarEstadoColor(element, value) {
        // Si no se pasa el valor, intentar leerlo del elemento
        if (!value) {
            value = element.value || element.textContent.trim();
            // Normalizar el valor del texto
            const estadosMap = {
                '-': '',
                'Sin comenzar': 'sin comenzar',
                'En curso': 'en curso',
                'Testing': 'Testing',
                'Entregado': 'Entregado',
                'Cerrado': 'Cerrado',
                'Rework': 'Rework',
                'Bloqueado': 'Bloqueado'
            };
            value = estadosMap[value] || value;
        }
        
        // Limpiar clases de estado anteriores
        element.className = 'modern-select estado-select';
        
        // Eliminar estilos inline de background que puedan interferir
        element.style.removeProperty('background');
        element.style.removeProperty('background-color');
        
        // Agregar la clase correspondiente al estado
        if (value === 'Entregado' || value === 'Cerrado') {
            element.classList.add('estado-entregado');
        } else if (value === 'sin comenzar') {
            element.classList.add('estado-sin-comenzar');
        } else if (value === 'en curso') {
            element.classList.add('estado-progreso');
        } else if (value === 'Testing') {
            element.classList.add('estado-testing');
        } else if (value === 'Rework') {
            element.classList.add('estado-rework');
        } else if (value === 'Bloqueado') {
            element.classList.add('estado-bloqueado');
        }
    }

    function actualizarRiesgoColor(select) {
        const value = select.value;
        select.className = 'modern-select riesgo-select';
        if (value === 'ok' || value === 'okey') {
            select.classList.add('riesgo-ok');
        } else if (value === 'red flag' || value === 'redflag') {
            select.classList.add('riesgo-red');
        }
    }

    async function actualizarMantenimiento(id_proyecto, campo, valor) {
        try {
            const endpoint = '/api/mantenimiento/' + id_proyecto;
            
            const datos = { [campo]: valor };
            console.log('Actualizando mantenimiento:', { id_proyecto, campo, valor });
            
            const response = await fetch(endpoint, {
                method: 'PUT',
                headers: { 
                    'Content-Type': 'application/json'
                },
                credentials: 'include', // Incluir cookies en la petici√≥n
                body: JSON.stringify(datos)
            });
            
            const result = await response.json();
            
            if (result.success) {
                console.log('‚úÖ Mantenimiento actualizado correctamente:', result.data);
            } else {
                console.error('‚ùå Error al actualizar mantenimiento:', result.error);
                alert('Error al actualizar: ' + (result.error || 'Error desconocido'));
            }
        } catch (error) {
            console.error('‚ùå Error al actualizar mantenimiento:', error);
            alert('Error al actualizar: ' + error.message);
        }
    }

    async function actualizarProyecto(id_proyecto, campo, valor) {
        try {
            const endpoint = '/api/proyectos/' + id_proyecto;
            
            const datos = { [campo]: valor };
            console.log('Actualizando proyecto:', { id_proyecto, campo, valor });
            
            const response = await fetch(endpoint, {
                method: 'PUT',
                headers: { 
                    'Content-Type': 'application/json'
                },
                credentials: 'include', // Incluir cookies en la petici√≥n
                body: JSON.stringify(datos)
            });
            
            const result = await response.json();
            
            if (result.success) {
                console.log('‚úÖ Proyecto actualizado correctamente:', result.data);
            } else {
                console.error('‚ùå Error al actualizar proyecto:', result.error);
                alert('Error al actualizar: ' + (result.error || 'Error desconocido'));
            }
        } catch (error) {
            console.error('‚ùå Error al actualizar proyecto:', error);
            alert('Error al actualizar: ' + error.message);
        }
    }
    
    async function actualizarSubproyecto(id_subproyecto, campo, valor) {
        try {
            const endpoint = '/api/subproyectos/' + id_subproyecto;
            
            const datos = { [campo]: valor };
            console.log('Actualizando subproyecto:', { id_subproyecto, campo, valor });
            
            const response = await fetch(endpoint, {
                method: 'PUT',
                headers: { 
                    'Content-Type': 'application/json'
                },
                credentials: 'include',
                body: JSON.stringify(datos)
            });
            
            const result = await response.json();
            
            if (result.success) {
                console.log('‚úÖ Subproyecto actualizado correctamente:', result.data);
            } else {
                console.error('‚ùå Error al actualizar subproyecto:', result.error);
                alert('Error al actualizar: ' + (result.error || 'Error desconocido'));
            }
        } catch (error) {
            console.error('‚ùå Error al actualizar subproyecto:', error);
            alert('Error al actualizar: ' + error.message);
        }
    }

    let progresoSincronizacion = 0;
    let intervaloProgreso = null;

    async function sincronizar() {
        if (!productoActual) {
            alert('Por favor selecciona un producto primero');
            return;
        }
        
        console.log('üîÑ Iniciando sincronizaci√≥n...');
        console.log('   Producto:', productoActual);
        console.log('   Equipo:', equipoActual || 'todos');
        console.log('   Tipo:', tipoActual);
        
        mostrarPopupSincronizacion();
        
        // Buscar el bot√≥n de sincronizaci√≥n (puede estar en el panel de filtros o en la tabla)
        const btnSincronizar = document.getElementById('btnSincronizar');
        let textoOriginal = null;
        if (btnSincronizar) {
            textoOriginal = btnSincronizar.innerHTML;
            btnSincronizar.disabled = true;
            btnSincronizar.innerHTML = '<div class="spinner"></div> <span>Sincronizando...</span>';
        }

        try {
            let endpoint = '';
            const bodyData = {
                producto: productoActual,
                equipo: equipoActual || null
            };
            
            if (tipoActual === 'mantenimiento') {
                endpoint = '/api/sincronizar/mantenimiento';
            } else if (tipoActual === 'proyectos') {
                endpoint = '/api/sincronizar/proyectos';
            } else {
                throw new Error('Tipo de sincronizaci√≥n no v√°lido: ' + tipoActual);
            }

            console.log('üì° Llamando a:', endpoint);
            console.log('üì¶ Datos enviados:', bodyData);

            const response = await fetch(endpoint, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'include',
                body: JSON.stringify(bodyData)
            });

            console.log('üì• Respuesta recibida, status:', response.status);

            if (!response.ok) {
                throw new Error(`Error HTTP: ${response.status} ${response.statusText}`);
            }

            const result = await response.json();
            console.log('‚úÖ Resultado de sincronizaci√≥n:', result);
            
            // Completar barra de progreso
            actualizarProgresoSincronizacion(100);
            
            setTimeout(() => {
                ocultarPopupSincronizacion();
                if (result.success) {
                    console.log('‚úÖ Sincronizaci√≥n exitosa, recargando datos...');
                    cargarDatos();
                } else {
                    console.error('‚ùå Error en sincronizaci√≥n:', result.error);
                    alert('Error en la sincronizaci√≥n: ' + (result.error || 'Error desconocido'));
                }
            }, 500);
        } catch (error) {
            console.error('‚ùå Error al sincronizar:', error);
            console.error('   Stack:', error.stack);
            ocultarPopupSincronizacion();
            alert('Error al sincronizar: ' + error.message);
        } finally {
            if (btnSincronizar && textoOriginal) {
                btnSincronizar.disabled = false;
                btnSincronizar.innerHTML = textoOriginal;
            }
        }
    }

    function mostrarPopupSincronizacion() {
        progresoSincronizacion = 0;
        
        // Crear overlay
        const overlay = document.createElement('div');
        overlay.id = 'syncOverlay';
        overlay.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 9999; display: flex; align-items: center; justify-content: center;';
        
        // Crear popup
        const popup = document.createElement('div');
        popup.id = 'syncPopup';
        popup.style.cssText = 'background: white; border-radius: 12px; padding: 24px; min-width: 320px; max-width: 400px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);';
        
        popup.innerHTML = '<div style="text-align: center;"><div style="font-size: 16px; font-weight: 500; color: #202124; margin-bottom: 16px; font-family: \'Google Sans\', \'Roboto\', sans-serif;">Sincronizando</div><div style="width: 100%; height: 8px; background: #f1f3f4; border-radius: 4px; overflow: hidden; margin-bottom: 8px;"><div id="syncProgressBar" style="height: 100%; background: #0D5AA2; width: 0%; transition: width 0.3s ease; border-radius: 4px;"></div></div><div id="syncProgressText" style="font-size: 13px; color: #5f6368; font-family: \'Roboto\', sans-serif;">0%</div></div>';
        
        overlay.appendChild(popup);
        document.body.appendChild(overlay);
        
        // Simular progreso
        intervaloProgreso = setInterval(() => {
            const incremento = 1 + Math.random() * 2;
            progresoSincronizacion += incremento;
            if (progresoSincronizacion > 90) {
                progresoSincronizacion = 90;
            }
            actualizarProgresoSincronizacion(progresoSincronizacion);
        }, 300);
    }

    function actualizarProgresoSincronizacion(porcentaje) {
        porcentaje = Math.max(0, Math.min(100, porcentaje));
        progresoSincronizacion = porcentaje;
        
        const progressBar = document.getElementById('syncProgressBar');
        const progressText = document.getElementById('syncProgressText');
        
        if (progressBar) {
            progressBar.style.width = porcentaje + '%';
        }
        if (progressText) {
            progressText.textContent = Math.round(porcentaje) + '%';
        }
        
        if (porcentaje >= 100 && intervaloProgreso) {
            clearInterval(intervaloProgreso);
            intervaloProgreso = null;
        }
    }

    function ocultarPopupSincronizacion() {
        if (intervaloProgreso) {
            clearInterval(intervaloProgreso);
            intervaloProgreso = null;
        }
        const overlay = document.getElementById('syncOverlay');
        if (overlay) {
            overlay.remove();
        }
        progresoSincronizacion = 0;
    }

    // Abrir modal de detalle del proyecto
    async function abrirModalDetalle(id_proyecto) {
        try {
            // Buscar el bot√≥n con los datos del proyecto
            // Usar window.tempModalButton si existe (para recargas), sino usar event normal
            // Buscar el elemento con data-item (puede ser un bot√≥n o un enlace)
            let btn = window.tempModalButton || (typeof event !== 'undefined' && event?.target) || document.querySelector('button[data-item][onclick*="' + id_proyecto + '"]') || document.querySelector('a[data-item][onclick*="' + id_proyecto + '"]');
            if (!btn) {
                console.error('No se encontr√≥ el elemento del proyecto');
                return;
            }
            const itemDataJson = btn.getAttribute('data-item');
            if (!itemDataJson) {
                console.error('No se encontraron datos del proyecto');
                return;
            }
            // Restaurar el JSON desde el atributo HTML
            const itemData = JSON.parse(itemDataJson.replace(/&quot;/g, '"').replace(/&#39;/g, "'"));
            const modal = document.getElementById('modalDetalle');
            const modalTitulo = document.getElementById('modalTitulo');
            const modalBody = document.getElementById('modalBody');
            
            modalTitulo.textContent = itemData.nombre_proyecto || 'Detalle del Proyecto';
            
            // Formatear fecha
            function formatearFecha(fecha) {
                if (!fecha) return '';
                if (typeof fecha === 'string') {
                    const match = fecha.match(/^(\d{4}-\d{2}-\d{2})/);
                    if (match) return match[1];
                    return fecha;
                }
                return '';
            }
            
            const horasEstimadas = parseFloat(itemData.horas_estimadas) || 0;
            const horasRealizadas = parseFloat(itemData.horas_realizadas) || 0;
            const fechaInicio = formatearFecha(itemData.fecha_inicio_epics || itemData.fecha_inicio || '');
            const fechaFin = formatearFecha(itemData.fecha_fin_epics || itemData.fecha_fin || '');
            const tieneEpics = itemData.tiene_epics || false;
            
            // Obtener fechas de los epics (m√≠nima de inicio, m√°xima de fin planificada, m√°xima de fin real)
            let fechaInicioPlanificada = null;
            let fechaFinPlanificada = null;
            let fechaFinReal = null;
            
            // Cargar epics
            let epicsHTML = '<div style="color: var(--text-secondary); font-style: italic; padding: 20px; text-align: center;">Cargando epics...</div>';
            
            try {
                const epicsResponse = await fetch('/api/epics/' + id_proyecto);
                const epicsData = await epicsResponse.json();
                const epics = epicsData.success ? epicsData.data : [];
                
                if (epics.length === 0) {
                    epicsHTML = '<div style="color: var(--text-secondary); font-style: italic; padding: 20px; text-align: center;">No hay epics sincronizados</div>';
                } else {
                    // Calcular fechas m√≠nimas y m√°ximas de los epics
                    const fechasInicio = epics.map(e => e.cf_21).filter(f => f);
                    const fechasFinPlanificada = epics.map(e => e.cf_22).filter(f => f);
                    const fechasFinReal = epics.map(e => e.cf_15).filter(f => f);
                    
                    if (fechasInicio.length > 0) {
                        fechaInicioPlanificada = fechasInicio.sort()[0]; // M√≠nima
                    }
                    if (fechasFinPlanificada.length > 0) {
                        fechaFinPlanificada = fechasFinPlanificada.sort().reverse()[0]; // M√°xima
                    }
                    if (fechasFinReal.length > 0) {
                        fechaFinReal = fechasFinReal.sort().reverse()[0]; // M√°xima
                    }
                    
                    // Agrupar epics por proyecto_padre si es diferente al id_proyecto
                    const epicsPorProyecto = {};
                    const epicsDelProyecto = [];
                    
                    epics.forEach(function(epic) {
                        const proyectoPadre = epic.proyecto_padre;
                        // Si proyecto_padre existe y es diferente al id_proyecto, agrupar
                        if (proyectoPadre && proyectoPadre !== id_proyecto) {
                            if (!epicsPorProyecto[proyectoPadre]) {
                                epicsPorProyecto[proyectoPadre] = [];
                            }
                            epicsPorProyecto[proyectoPadre].push(epic);
                        } else {
                            // Si proyecto_padre == id_proyecto o no existe, agregar directamente
                            epicsDelProyecto.push(epic);
                        }
                    });
                    
                    epicsHTML = '<div class="epics-list">';
                    
                    // Funci√≥n para renderizar un epic
                    function renderizarEpic(epic) {
                        const epicUrl = 'https://redmine.mercap.net/issues/' + epic.epic_id;
                        const epicTitle = epic.subject || 'Epic #' + epic.epic_id;
                        let html = '<div class="epic-item" style="background: white; border: 1px solid var(--border-color); border-radius: 8px; padding: 16px; margin-bottom: 12px;">';
                        html += '<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">';
                        html += '<div style="display: flex; flex-direction: column; gap: 4px;">';
                        html += '<div style="font-size: 11px; color: var(--text-secondary); font-weight: 500;">Epic #' + epic.epic_id + '</div>';
                        html += '<div style="font-size: 14px; font-weight: 500; color: var(--text-primary);"><a href="' + epicUrl + '" target="_blank" style="color: var(--primary-color); text-decoration: none;">' + epicTitle + '</a></div>';
                        html += '</div>';
                        // Agregar fondo de color seg√∫n el estado del epic
                        const estadoEpic = epic.status || '';
                        let estadoEpicBg = '';
                        const estadoLower = estadoEpic.toLowerCase();
                        
                        // Estados cerrados/entregados: verde suave con transparencia
                        if (estadoLower.includes('cerrado') || estadoLower.includes('closed') || 
                            estadoLower.includes('entregado') || estadoLower.includes('resuelto') || 
                            estadoLower.includes('resolved')) {
                            estadoEpicBg = 'rgba(30, 142, 62, 0.1)'; // Verde suave con transparencia
                        } 
                        // Estados abiertos: azul suave con transparencia
                        else if (estadoLower.includes('nuevo') || estadoLower.includes('new') || 
                                 estadoLower.includes('en progreso') || estadoLower.includes('in progress') ||
                                 estadoLower.includes('abierto') || estadoLower.includes('open')) {
                            estadoEpicBg = 'rgba(26, 115, 232, 0.1)'; // Azul suave con transparencia
                        }
                        
                        html += '<div style="font-size: 12px; color: var(--text-secondary); padding: 4px 8px; border-radius: 12px; background: ' + (estadoEpicBg || 'transparent') + '; display: inline-block;">' + (estadoEpic || '-') + '</div>';
                        html += '</div>';
                        html += '<div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; font-size: 13px; color: var(--text-secondary);">';
                        html += '<div>Est.: ' + (parseFloat(epic.total_estimated_hours) || 0).toFixed(1) + 'h</div>';
                        html += '<div>Real.: ' + (parseFloat(epic.total_spent_hours) || 0).toFixed(1) + 'h</div>';
                        html += '<div>Inicio: ' + (epic.cf_21 ? formatearFecha(epic.cf_21) : '-') + '</div>';
                        html += '<div>Fin Real: ' + (epic.cf_15 ? formatearFecha(epic.cf_15) : '-') + '</div>';
                        html += '</div>';
                        html += '</div>';
                        return html;
                    }
                    
                    // Renderizar epics del proyecto principal (si hay)
                    if (epicsDelProyecto.length > 0) {
                        epicsDelProyecto.forEach(function(epic) {
                            epicsHTML += renderizarEpic(epic);
                        });
                    }
                    
                    // Renderizar epics agrupados por proyecto_padre (ordenados alfab√©ticamente por nombre)
                    const proyectosPadreOrdenados = Object.keys(epicsPorProyecto).sort(function(a, b) {
                        const nombreA = epicsPorProyecto[a][0]?.nombre_proyecto_padre || 'Proyecto #' + a;
                        const nombreB = epicsPorProyecto[b][0]?.nombre_proyecto_padre || 'Proyecto #' + b;
                        return nombreA.localeCompare(nombreB);
                    });
                    
                    proyectosPadreOrdenados.forEach(function(proyectoPadreId) {
                        const epicsDelSubproyecto = epicsPorProyecto[proyectoPadreId];
                        // Obtener el nombre del proyecto padre del primer epic del grupo
                        const nombreProyectoPadre = epicsDelSubproyecto[0]?.nombre_proyecto_padre || 'Proyecto #' + proyectoPadreId;
                        epicsHTML += '<div style="margin-top: 24px; margin-bottom: 16px; padding-top: 16px; border-top: 2px solid var(--border-color);">';
                        epicsHTML += '<div style="font-size: 14px; font-weight: 600; color: var(--text-primary); margin-bottom: 12px;">' + nombreProyectoPadre + '</div>';
                        epicsDelSubproyecto.forEach(function(epic) {
                            epicsHTML += renderizarEpic(epic);
                        });
                        epicsHTML += '</div>';
                    });
                    
                    epicsHTML += '</div>';
                }
            } catch (error) {
                console.error('Error al cargar epics:', error);
                epicsHTML = '<div style="color: #d93025; padding: 20px; text-align: center;">Error al cargar epics</div>';
            }
            
            // Agregar enlace a Redmine debajo del t√≠tulo
            const redmineLink = itemData.redmineUrl || ('https://redmine.mercap.net/projects/' + (itemData.codigo_proyecto || ''));
            
            let contenido = '<div style="display: flex; flex-direction: column; gap: 24px;">';
            
            // Enlace a Redmine
            const codigoProyecto = itemData.codigo_proyecto || '';
            contenido += '<div style="margin-bottom: 8px;"><a href="' + redmineLink + '" target="_blank" style="color: var(--primary-color); text-decoration: none; font-size: 14px; font-weight: 400;">Redmine + ' + codigoProyecto + '</a></div>';
            
            // Dos columnas principales - columna izquierda m√°s estrecha, derecha m√°s ancha
            contenido += '<div style="display: grid; grid-template-columns: 0.8fr 1.2fr; gap: 32px;">';
            
            // Columna izquierda: Informaci√≥n del proyecto
            contenido += '<div style="display: flex; flex-direction: column; gap: 20px;">';
            contenido += '<h3 style="font-size: 18px; font-weight: 500; color: var(--text-primary); margin-bottom: 16px;">Informaci√≥n del Proyecto</h3>';
            
            // Horas estimadas y realizadas
            contenido += '<div><label style="display: block; font-size: 13px; font-weight: 500; color: var(--text-secondary); margin-bottom: 8px;">Horas Estimadas</label>';
            contenido += '<div style="font-size: 16px; color: var(--text-primary); font-weight: 500;">' + (horasEstimadas > 0 ? horasEstimadas.toFixed(1) : '-') + 'h</div></div>';
            
            contenido += '<div><label style="display: block; font-size: 13px; font-weight: 500; color: var(--text-secondary); margin-bottom: 8px;">Horas Realizadas</label>';
            contenido += '<div style="font-size: 16px; color: var(--text-primary); font-weight: 500;">' + (horasRealizadas > 0 ? horasRealizadas.toFixed(1) : '-') + 'h</div></div>';
            
            // Fechas - Mostrar las 3 fechas de los epics
            contenido += '<div><label style="display: block; font-size: 13px; font-weight: 500; color: var(--text-secondary); margin-bottom: 8px;">Fecha Inicio Planificada</label>';
            if (!tieneEpics || !fechaInicioPlanificada) {
                contenido += '<div style="width: 100%; padding: 10px 16px; border-radius: 8px; border: 1px solid var(--border-color); font-size: 14px; font-family: \'Google Sans\', \'Roboto\', sans-serif; background: #f8f9fa; color: var(--text-secondary);">-</div></div>';
            } else {
                contenido += '<input type="date" class="modern-input date-input" value="' + formatearFecha(fechaInicioPlanificada) + '" readonly style="width: 100%; padding: 10px 16px; border-radius: 8px; border: 1px solid var(--border-color); font-size: 14px; font-family: \'Google Sans\', \'Roboto\', sans-serif; background: #f8f9fa; cursor: not-allowed;"></div>';
            }
            
            contenido += '<div><label style="display: block; font-size: 13px; font-weight: 500; color: var(--text-secondary); margin-bottom: 8px;">Fecha Fin Planificada</label>';
            if (!tieneEpics || !fechaFinPlanificada) {
                contenido += '<div style="width: 100%; padding: 10px 16px; border-radius: 8px; border: 1px solid var(--border-color); font-size: 14px; font-family: \'Google Sans\', \'Roboto\', sans-serif; background: #f8f9fa; color: var(--text-secondary);">-</div></div>';
            } else {
                contenido += '<input type="date" class="modern-input date-input" value="' + formatearFecha(fechaFinPlanificada) + '" readonly style="width: 100%; padding: 10px 16px; border-radius: 8px; border: 1px solid var(--border-color); font-size: 14px; font-family: \'Google Sans\', \'Roboto\', sans-serif; background: #f8f9fa; cursor: not-allowed;"></div>';
            }
            
            // Solo mostrar Fecha Fin Real si el proyecto est√° entregado o cerrado
            const estadoProyecto = (itemData.estado || '').toLowerCase();
            const mostrarFechaFinReal = estadoProyecto === 'entregado' || estadoProyecto === 'cerrado';
            
            if (mostrarFechaFinReal) {
                contenido += '<div><label style="display: block; font-size: 13px; font-weight: 500; color: var(--text-secondary); margin-bottom: 8px;">Fecha Fin Real</label>';
                if (!tieneEpics || !fechaFinReal) {
                    contenido += '<div style="width: 100%; padding: 10px 16px; border-radius: 8px; border: 1px solid var(--border-color); font-size: 14px; font-family: \'Google Sans\', \'Roboto\', sans-serif; background: #f8f9fa; color: var(--text-secondary);">-</div></div>';
                } else {
                    contenido += '<input type="date" class="modern-input date-input" value="' + formatearFecha(fechaFinReal) + '" readonly style="width: 100%; padding: 10px 16px; border-radius: 8px; border: 1px solid var(--border-color); font-size: 14px; font-family: \'Google Sans\', \'Roboto\', sans-serif; background: #f8f9fa; cursor: not-allowed;"></div>';
                }
            }
            
            // Bot√≥n de acci√≥n
            contenido += '<div style="margin-top: 8px;">';
            contenido += '<button class="button" onclick="sincronizarEpicsDesdeModal(' + id_proyecto + ', \'' + (itemData.codigo_proyecto || '').replace(/'/g, "\\'") + '\', this)" style="width: 100%; padding: 10px; font-size: 13px; white-space: nowrap;"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="currentColor" style="margin-right: 8px; vertical-align: middle;"><path d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/></svg>Sincronizar Epics</button>';
            contenido += '</div>';
            
            contenido += '</div>';
            
            // Columna derecha: Lista de epics
            contenido += '<div style="display: flex; flex-direction: column; gap: 20px;">';
            contenido += '<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">';
            contenido += '<h3 style="font-size: 18px; font-weight: 500; color: var(--text-primary); margin: 0;">Epics Sincronizados</h3>';
            contenido += '<div style="font-size: 13px; color: var(--text-secondary);">' + (tieneEpics ? 'Total: ' + (parseFloat(itemData.horas_estimadas) || 0).toFixed(1) + 'h est. / ' + (parseFloat(itemData.horas_realizadas) || 0).toFixed(1) + 'h real.' : 'Sin epics') + '</div>';
            contenido += '</div>';
            contenido += epicsHTML;
            contenido += '</div>';
            
            contenido += '</div>'; // Cerrar grid de 2 columnas
            contenido += '</div>'; // Cerrar contenedor principal
            
            modalBody.innerHTML = contenido;
            modal.style.display = 'flex';
            document.body.style.overflow = 'hidden';
        } catch (error) {
            console.error('Error al abrir modal:', error);
            alert('Error al abrir detalles del proyecto');
        }
    }
    
    // Funci√≥n para expandir/contraer proyectos secundarios (con carga lazy)
    async function toggleProyectosSecundarios(id_proyecto, btn) {
        const filasSecundarias = document.querySelectorAll('.proyecto-secundario-' + id_proyecto);
        const isExpanded = filasSecundarias.length > 0 && filasSecundarias[0].style.display !== 'none';
        
        // Si est√° expandido, solo ocultar
        if (isExpanded) {
            filasSecundarias.forEach(function(fila) {
                fila.style.display = 'none';
            });
            btn.textContent = '‚ñ∂';
            btn.style.transform = 'rotate(0deg)';
            return;
        }
        
        // Si no est√° expandido, cargar subproyectos bajo demanda
        if (filasSecundarias.length === 0) {
            // Mostrar indicador de carga
            const textoOriginal = btn.textContent;
            btn.textContent = '‚è≥';
            btn.disabled = true;
            btn.style.cursor = 'wait';
            
            try {
                console.log('üì¶ Cargando subproyectos para proyecto:', id_proyecto);
                const inicio = performance.now();
                
                const response = await fetch('/api/proyectos/' + id_proyecto + '/subproyectos', {
                    credentials: 'include',
                    headers: {
                        'Accept': 'application/json'
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const result = await response.json();
                const tiempo = (performance.now() - inicio).toFixed(2);
                console.log(`‚úÖ Subproyectos cargados en ${tiempo}ms`);
                
                if (result.success && result.data && result.data.length > 0) {
                    // Renderizar subproyectos din√°micamente
                    const filaProyecto = btn.closest('.modern-table-row');
                    if (filaProyecto) {
                        // Renderizar todos los subproyectos de una vez
                        const fragment = document.createDocumentFragment();
                        result.data.forEach(function(subproyecto) {
                            const fila = crearFilaSubproyecto(id_proyecto, subproyecto, filaProyecto);
                            if (fila) {
                                fragment.appendChild(fila);
                            }
                        });
                        // Insertar todas las filas de una vez (m√°s eficiente)
                        filaProyecto.parentNode.insertBefore(fragment, filaProyecto.nextSibling);
                    }
                } else {
                    console.log('‚ÑπÔ∏è No hay subproyectos para este proyecto');
                    btn.textContent = textoOriginal;
                    btn.disabled = false;
                    btn.style.cursor = 'pointer';
                    return;
                }
            } catch (error) {
                console.error('‚ùå Error al cargar subproyectos:', error);
                alert('Error al cargar subproyectos: ' + error.message);
                btn.textContent = textoOriginal;
                btn.disabled = false;
                btn.style.cursor = 'pointer';
                return;
            }
            
            btn.disabled = false;
            btn.style.cursor = 'pointer';
        }
        
        // Mostrar las filas de subproyectos
        const filasSecundariasActualizadas = document.querySelectorAll('.proyecto-secundario-' + id_proyecto);
        filasSecundariasActualizadas.forEach(function(fila) {
            fila.style.display = '';
        });
        
        // Cambiar la flecha
        btn.textContent = '‚ñº';
        btn.style.transform = 'rotate(0deg)';
    }
    
    // Funci√≥n para crear una fila de subproyecto (optimizada - retorna elemento DOM en lugar de insertar directamente)
    function crearFilaSubproyecto(id_proyecto, subproyecto, filaProyectoPadre) {
        // Crear la fila de subproyecto
        const filaSubproyecto = document.createElement('div');
        filaSubproyecto.className = 'modern-table-row proyecto-secundario-' + id_proyecto + ' subproyecto-row';
        filaSubproyecto.setAttribute('data-id-proyecto', id_proyecto);
        filaSubproyecto.setAttribute('data-id-subproyecto', subproyecto.id_subproyecto);
        filaSubproyecto.style.display = 'none';
        
        // Crear celdas usando createElement (m√°s r√°pido que innerHTML para m√∫ltiples elementos)
        const celdas = [
            { class: 'modern-table-cell', style: 'width: 40px;', content: '' },
            { class: 'modern-table-cell item-text', content: '' },
            { class: 'modern-table-cell item-text', style: 'padding-left: 24px; font-style: italic; color: var(--text-secondary);', content: subproyecto.nombre || '-' }
        ];
        
        celdas.forEach(celda => {
            const div = document.createElement('div');
            div.className = celda.class;
            if (celda.style) div.setAttribute('style', celda.style);
            div.textContent = celda.content;
            filaSubproyecto.appendChild(div);
        });
        
        // Estado
        const estadoSubproyecto = subproyecto.estado || '';
        let estadoClassSub = '';
        if (estadoSubproyecto === 'Entregado' || estadoSubproyecto === 'Cerrado') {
            estadoClassSub = 'estado-entregado';
        } else if (estadoSubproyecto === 'sin comenzar') {
            estadoClassSub = 'estado-sin-comenzar';
        } else if (estadoSubproyecto === 'en curso') {
            estadoClassSub = 'estado-progreso';
        } else if (estadoSubproyecto === 'Testing') {
            estadoClassSub = 'estado-testing';
        } else if (estadoSubproyecto === 'Rework') {
            estadoClassSub = 'estado-rework';
        } else if (estadoSubproyecto === 'Bloqueado') {
            estadoClassSub = 'estado-bloqueado';
        }
        
        const celdaEstado = document.createElement('div');
        celdaEstado.className = 'modern-table-cell';
        celdaEstado.innerHTML = crearDropdownEstado(subproyecto.id_subproyecto, estadoSubproyecto, 'subproyecto ' + estadoClassSub);
        filaSubproyecto.appendChild(celdaEstado);
        
        // Overall
        const celdaOverall = document.createElement('div');
        celdaOverall.className = 'modern-table-cell';
        celdaOverall.innerHTML = crearDropdownOverall(subproyecto.id_subproyecto, 'overall', subproyecto.overall || '', 'subproyecto');
        filaSubproyecto.appendChild(celdaOverall);
        
        // Alcance
        const celdaAlcance = document.createElement('div');
        celdaAlcance.className = 'modern-table-cell';
        celdaAlcance.innerHTML = crearDropdownOverall(subproyecto.id_subproyecto, 'alcance', subproyecto.alcance || '', 'subproyecto');
        filaSubproyecto.appendChild(celdaAlcance);
        
        // Costo
        const celdaCosto = document.createElement('div');
        celdaCosto.className = 'modern-table-cell';
        celdaCosto.innerHTML = crearDropdownOverall(subproyecto.id_subproyecto, 'costo', subproyecto.costo || '', 'subproyecto');
        filaSubproyecto.appendChild(celdaCosto);
        
        // Plazos
        const celdaPlazos = document.createElement('div');
        celdaPlazos.className = 'modern-table-cell';
        celdaPlazos.innerHTML = crearDropdownOverall(subproyecto.id_subproyecto, 'plazos', subproyecto.plazos || '', 'subproyecto');
        filaSubproyecto.appendChild(celdaPlazos);
        
        // Riesgos
        const celdaRiesgos = document.createElement('div');
        celdaRiesgos.className = 'modern-table-cell';
        celdaRiesgos.innerHTML = crearDropdownRiesgo(subproyecto.id_subproyecto, subproyecto.riesgos || '', 'subproyecto');
        filaSubproyecto.appendChild(celdaRiesgos);
        
        // Avance
        const avanceSubproyecto = parseInt(subproyecto.avance) || 0;
        let avanceGradientSub = 'linear-gradient(90deg, #66bb6a 0%, #34a853 100%)';
        if (avanceSubproyecto <= 25) {
            avanceGradientSub = 'linear-gradient(90deg, #a5d6a7 0%, #81c784 100%)';
        } else if (avanceSubproyecto <= 50) {
            avanceGradientSub = 'linear-gradient(90deg, #81c784 0%, #66bb6a 100%)';
        } else if (avanceSubproyecto <= 75) {
            avanceGradientSub = 'linear-gradient(90deg, #66bb6a 0%, #4caf50 100%)';
        } else {
            avanceGradientSub = 'linear-gradient(90deg, #4caf50 0%, #34a853 50%, #1e8e3e 100%)';
        }
        const celdaAvance = document.createElement('div');
        celdaAvance.className = 'modern-table-cell';
        celdaAvance.innerHTML = '<div class="progress-bar-container" data-id="' + subproyecto.id_subproyecto + '"><div class="progress-bar" style="width: ' + avanceSubproyecto + '%; background: ' + avanceGradientSub + ';"></div><input type="range" min="0" max="100" step="5" value="' + avanceSubproyecto + '" class="progress-slider" oninput="actualizarBarraProgreso(this);" onchange="actualizarSubproyecto(' + subproyecto.id_subproyecto + ', \'avance\', this.value);" /></div>';
        filaSubproyecto.appendChild(celdaAvance);
        
        return filaSubproyecto;
    }
    
    // Cerrar modal de detalle
    function cerrarModalDetalle() {
        const modal = document.getElementById('modalDetalle');
        modal.style.display = 'none';
        document.body.style.overflow = 'auto';
    }
    
    // Actualizar fecha en el modal despu√©s de guardar
    function actualizarFechaEnModal(id_proyecto, campo, valor) {
        // La fecha ya se actualiz√≥ en el input, no necesitamos hacer nada m√°s
    }
    
    // Sincronizar epics desde el modal
    async function sincronizarEpicsDesdeModal(id_proyecto, codigo_proyecto, btnElement) {
        // Usar el bot√≥n pasado como par√°metro
        const btn = btnElement || (typeof event !== 'undefined' && event?.target?.closest('button'));
        if (!btn) {
            console.error('No se encontr√≥ el bot√≥n');
            return;
        }
        const textoOriginal = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = '<div class="spinner" style="width: 16px; height: 16px; border-width: 2px;"></div> <span>Sincronizando...</span>';
        
        try {
            const response = await fetch('/api/sincronizar/epics', {
                method: 'POST',
                headers: { 
                    'Content-Type': 'application/json'
                },
                credentials: 'include',
                body: JSON.stringify({
                    id_proyecto: id_proyecto,
                    codigo_proyecto: codigo_proyecto
                })
            });
            
            const result = await response.json();
            
            if (result.success) {
                console.log('‚úÖ Epics sincronizados:', result.data);
                // Actualizar el enlace del proyecto con los nuevos datos
                const linkProyecto = document.querySelector('a[data-item][onclick*="' + id_proyecto + '"]');
                if (linkProyecto) {
                    const itemDataJson = linkProyecto.getAttribute('data-item');
                    if (itemDataJson) {
                        const itemData = JSON.parse(itemDataJson.replace(/&quot;/g, '"').replace(/&#39;/g, "'"));
                        itemData.horas_estimadas = parseFloat(result.data.horas_estimadas) || 0;
                        itemData.horas_realizadas = parseFloat(result.data.horas_realizadas) || 0;
                        itemData.fecha_inicio_epics = result.data.fecha_inicio || '';
                        itemData.fecha_fin_epics = result.data.fecha_fin || '';
                        itemData.tiene_epics = true;
                        linkProyecto.setAttribute('data-item', JSON.stringify(itemData).replace(/"/g, '&quot;').replace(/'/g, '&#39;'));
                    }
                }
                // Recargar el modal con los nuevos datos
                if (linkProyecto) {
                    // Guardar el enlace temporalmente para que abrirModalDetalle lo use
                    window.tempModalButton = linkProyecto;
                    await abrirModalDetalle(id_proyecto);
                    delete window.tempModalButton;
                }
                // Tambi√©n recargar la tabla principal
                cargarDatos();
            } else {
                alert('Error al sincronizar epics: ' + (result.error || 'Error desconocido'));
                btn.disabled = false;
                btn.innerHTML = textoOriginal;
            }
        } catch (error) {
            console.error('Error al sincronizar epics:', error);
            alert('Error al sincronizar epics: ' + error.message);
            btn.disabled = false;
            btn.innerHTML = textoOriginal;
        }
    }
    
    // Sincronizar epics de un proyecto
    async function sincronizarEpics(id_proyecto, codigo_proyecto) {
        try {
            const btn = event.target.closest('button');
            const textoOriginal = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<div class="spinner" style="width: 16px; height: 16px; border-width: 2px;"></div> <span>Sincronizando...</span>';
            
            const response = await fetch('/api/sincronizar/epics', {
                method: 'POST',
                headers: { 
                    'Content-Type': 'application/json'
                },
                credentials: 'include',
                body: JSON.stringify({
                    id_proyecto: id_proyecto,
                    codigo_proyecto: codigo_proyecto
                })
            });
            
            const result = await response.json();
            
            if (result.success) {
                console.log('‚úÖ Epics sincronizados:', result.data);
                // Recargar datos para mostrar las horas y fechas actualizadas
                cargarDatos();
            } else {
                alert('Error al sincronizar epics: ' + (result.error || 'Error desconocido'));
                btn.disabled = false;
                btn.innerHTML = textoOriginal;
            }
        } catch (error) {
            console.error('Error al sincronizar epics:', error);
            alert('Error al sincronizar epics: ' + error.message);
            const btn = event.target.closest('button');
            btn.disabled = false;
            btn.innerHTML = textoOriginal;
        }
    }

    // B√∫squeda
    function buscar(event) {
        if (event) event.preventDefault();
        const searchInput = document.getElementById('searchInput');
        if (searchInput) {
            busquedaActual = searchInput.value;
            cargarDatos();
        }
    }

    // B√∫squeda con sugerencias - optimizada con debounce m√°s largo
    let timeoutSugerencias;
    async function buscarSugerencias(query) {
        clearTimeout(timeoutSugerencias);
        
        const suggestionsContainer = document.getElementById('searchSuggestions');
        if (!suggestionsContainer) return;
        
        if (!query || query.length < 2) {
            suggestionsContainer.style.display = 'none';
            return;
        }
        
        // Debounce m√°s largo para mejorar performance (500ms en lugar de 300ms)
        timeoutSugerencias = setTimeout(async () => {
            try {
                const endpoint = '/api/proyectos/sugerencias?q=' + encodeURIComponent(query);
                
                const response = await fetch(endpoint);
                const data = await response.json();
                
                if (data.success && data.sugerencias && data.sugerencias.length > 0) {
                    const html = data.sugerencias.map(item => `
                        <div class="google-suggestion-item" onclick="seleccionarSugerencia('${item.nombre_proyecto || item.nombre || ''}')">
                            <div class="suggestion-icon">${(item.nombre_proyecto || item.nombre || '?').substring(0, 1).toUpperCase()}</div>
                            <div class="suggestion-text">
                                <div class="suggestion-title">${item.nombre_proyecto || item.nombre || 'Sin nombre'}</div>
                                <div class="suggestion-subtitle">${item.cliente || item.producto || ''}</div>
                            </div>
                        </div>
                    `).join('');
                    
                    suggestionsContainer.innerHTML = html;
                    suggestionsContainer.style.display = 'block';
                } else {
                    suggestionsContainer.style.display = 'none';
                }
            } catch (error) {
                console.error('Error al obtener sugerencias:', error);
                suggestionsContainer.style.display = 'none';
            }
        }, 500);
    }
    
    // Funci√≥n para actualizar visibilidad del bot√≥n limpiar
    function actualizarBotonLimpiar(valor) {
        const btnLimpiar = document.getElementById('btnLimpiarBusqueda');
        if (btnLimpiar) {
            btnLimpiar.style.display = valor && valor.trim().length > 0 ? 'flex' : 'none';
        }
    }
    
    // Funci√≥n para limpiar la b√∫squeda y refrescar
    function limpiarBusqueda() {
        const searchInput = document.getElementById('searchInput');
        if (searchInput) {
            searchInput.value = '';
            searchInput.style.height = 'auto';
            searchInput.style.height = Math.min(searchInput.scrollHeight, 44) + 'px';
            busquedaActual = '';
            actualizarBotonLimpiar('');
            const suggestionsContainer = document.getElementById('searchSuggestions');
            if (suggestionsContainer) {
                suggestionsContainer.style.display = 'none';
            }
            // Refrescar la p√°gina
            window.location.reload();
        }
    }

    function seleccionarSugerencia(texto) {
        const searchInput = document.getElementById('searchInput');
        if (searchInput) {
            searchInput.value = texto;
            busquedaActual = texto;
            document.getElementById('searchSuggestions').style.display = 'none';
            cargarDatos();
        }
    }

    // Cerrar sugerencias al hacer clic fuera
    document.addEventListener('click', (e) => {
        if (!e.target.closest('.google-search-box')) {
            const suggestions = document.getElementById('searchSuggestions');
            if (suggestions) {
                suggestions.style.display = 'none';
            }
        }
    });

    // Toggle filters
    function toggleFilterClientes(buttonElement) {
        const dropdown = document.getElementById('filterClientes');
        const estadosDropdown = document.getElementById('filterEstados');
        
        if (estadosDropdown) estadosDropdown.style.display = 'none';
        
        if (dropdown) {
            const isVisible = dropdown.style.display === 'block';
            if (isVisible) {
                dropdown.style.display = 'none';
            } else {
                const button = buttonElement || document.querySelector('button[onclick*="toggleFilterClientes"]');
                if (button) {
                    const rect = button.getBoundingClientRect();
                    dropdown.style.position = 'fixed';
                    dropdown.style.top = (rect.bottom + 4) + 'px';
                    dropdown.style.left = rect.left + 'px';
                    dropdown.style.zIndex = '10000';
                    dropdown.style.background = 'white';
                }
                dropdown.style.display = 'block';
            }
        }
    }

    function toggleFilterEstados(buttonElement) {
        const dropdown = document.getElementById('filterEstados');
        const clientesDropdown = document.getElementById('filterClientes');
        
        if (clientesDropdown) clientesDropdown.style.display = 'none';
        
        if (dropdown) {
            const isVisible = dropdown.style.display === 'block';
            if (isVisible) {
                dropdown.style.display = 'none';
            } else {
                const button = buttonElement || document.querySelector('button[onclick*="toggleFilterEstados"]');
                if (button) {
                    const rect = button.getBoundingClientRect();
                    dropdown.style.position = 'fixed';
                    dropdown.style.top = (rect.bottom + 4) + 'px';
                    dropdown.style.left = rect.left + 'px';
                    dropdown.style.zIndex = '10000';
                    dropdown.style.background = 'white';
                }
                dropdown.style.display = 'block';
            }
        }
    }

    // Cerrar dropdowns al hacer click fuera
    document.addEventListener('click', (e) => {
        const filterClientes = document.getElementById('filterClientes');
        const filterEstados = document.getElementById('filterEstados');
        
        if (filterClientes && !e.target.closest('#filterClientes') && !e.target.closest('button[onclick*="toggleFilterClientes"]')) {
            filterClientes.style.display = 'none';
        }
        
        if (filterEstados && !e.target.closest('#filterEstados') && !e.target.closest('button[onclick*="toggleFilterEstados"]')) {
            filterEstados.style.display = 'none';
        }
    });

    function aplicarFiltrosProyectos() {
        filtrosClientes = Array.from(document.querySelectorAll('.filter-checkbox-cliente:checked')).map(cb => cb.value);
        filtrosEstados = Array.from(document.querySelectorAll('.filter-checkbox-estado:checked')).map(cb => cb.value);
        actualizarFiltrosAplicados();
        cargarDatos();
    }

    function actualizarFiltrosAplicados() {
        const filtrosAplicados = document.getElementById('filtrosAplicados');
        if (!filtrosAplicados) return;
        
        const tieneFiltros = filtrosClientes.length > 0 || filtrosEstados.length > 0;
        
        if (!tieneFiltros) {
            filtrosAplicados.style.display = 'none';
            filtrosAplicados.innerHTML = '';
            return;
        }
        
        filtrosAplicados.style.display = 'flex';
        let html = '';
        
        filtrosClientes.forEach(cliente => {
            html += '<div class="filter-chip" style="display: inline-flex; align-items: center; background: #e8f0fe; color: var(--primary-color); padding: 6px 12px; border-radius: 16px; font-size: 13px; font-weight: 500; gap: 8px;"><span>Cliente: ' + cliente + '</span><button onclick="removerFiltroCliente(\'' + cliente.replace(/'/g, "\\'") + '\')" style="background: none; border: none; cursor: pointer; padding: 0; display: flex; align-items: center; color: var(--primary-color);"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg></button></div>';
        });
        
        filtrosEstados.forEach(estado => {
            html += '<div class="filter-chip" style="display: inline-flex; align-items: center; background: #fef7e0; color: #f9ab00; padding: 6px 12px; border-radius: 16px; font-size: 13px; font-weight: 500; gap: 8px;"><span>Estado: ' + estado + '</span><button onclick="removerFiltroEstado(\'' + estado.replace(/'/g, "\\'") + '\')" style="background: none; border: none; cursor: pointer; padding: 0; display: flex; align-items: center; color: #f9ab00;"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg></button></div>';
        });
        
        if (tieneFiltros) {
            html += '<button onclick="limpiarFiltrosProyectos()" style="background: rgb(241, 243, 244); border: none; color: var(--text-secondary); font-size: 13px; cursor: pointer; padding: 6px 12px; border-radius: 16px; transition: background 0.2s;" onmouseover="this.style.background=\'#e8eaed\'" onmouseout="this.style.background=\'rgb(241, 243, 244)\'">Borrar filtros</button>';
        }
        
        filtrosAplicados.innerHTML = html;
    }

    function removerFiltroCliente(cliente) {
        filtrosClientes = filtrosClientes.filter(c => c !== cliente);
        const checkbox = document.querySelector('.filter-checkbox-cliente[value="' + cliente + '"]');
        if (checkbox) checkbox.checked = false;
        actualizarFiltrosAplicados();
        cargarDatos();
    }

    function removerFiltroEstado(estado) {
        filtrosEstados = filtrosEstados.filter(e => e !== estado);
        const checkbox = document.querySelector('.filter-checkbox-estado[value="' + estado + '"]');
        if (checkbox) checkbox.checked = false;
        actualizarFiltrosAplicados();
        cargarDatos();
    }

    function limpiarFiltrosProyectos() {
        filtrosClientes = [];
        filtrosEstados = [];
        document.querySelectorAll('.filter-checkbox-cliente, .filter-checkbox-estado').forEach(cb => cb.checked = false);
        actualizarFiltrosAplicados();
        cargarDatos();
    }
    
    function seleccionarTodosClientes() {
        document.querySelectorAll('.filter-checkbox-cliente').forEach(cb => cb.checked = true);
        aplicarFiltrosProyectos();
    }
    
    function deseleccionarTodosClientes() {
        document.querySelectorAll('.filter-checkbox-cliente').forEach(cb => cb.checked = false);
        aplicarFiltrosProyectos();
    }
    
    function seleccionarTodosEstados() {
        document.querySelectorAll('.filter-checkbox-estado').forEach(cb => cb.checked = true);
        aplicarFiltrosProyectos();
    }
    
    function deseleccionarTodosEstados() {
        document.querySelectorAll('.filter-checkbox-estado').forEach(cb => cb.checked = false);
        aplicarFiltrosProyectos();
    }
    
    // Variables para ordenamiento
    let ordenActual = { columna: 'cliente', direccion: 'asc' };
    const ordenEstados = ['sin comenzar', 'en curso', 'Testing', 'Entregado', 'Cerrado', 'Rework', 'Bloqueado'];
    
    function ordenarPor(columna) {
        if (ordenActual.columna === columna) {
            ordenActual.direccion = ordenActual.direccion === 'asc' ? 'desc' : 'asc';
        } else {
            ordenActual.columna = columna;
            ordenActual.direccion = 'asc';
        }
        cargarDatos();
    }
</script>
    
    <!-- Modal de Detalle del Proyecto -->
    <div id="modalDetalle" class="modal-overlay" style="display: none;" onclick="if(event.target === this) cerrarModalDetalle()">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h2 id="modalTitulo" style="margin: 0; font-size: 20px; font-weight: 500;">Detalle del Proyecto</h2>
                <button class="modal-close" onclick="cerrarModalDetalle()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: var(--text-secondary); padding: 0; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; border-radius: 50%; transition: background 0.2s;" onmouseover="this.style.background='#f1f3f4'" onmouseout="this.style.background='none'">√ó</button>
            </div>
            <div class="modal-body" id="modalBody">
                <!-- Contenido din√°mico -->
            </div>
        </div>
    </div>
    
    <!-- JavaScript -->
    <script src="/js/main.js"></script>
</body>
</html>
